<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>فهرس القيد - ث. ش. محمد عبدالعزيز الكنعان</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Tajawal', sans-serif; }
        .loader { border-top-color: #0ea5e9; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media print {
            .no-print { display: none !important; }
            .print-area { display: block !important; }
            body { background: white !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 transition-colors duration-300">
    <div id="root"></div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <script type="text/babel">
        // استخراج المكونات من React مباشرة لتجنب مشاكل الـ Import
        const { useState, useEffect, useMemo, useRef } = React;

        // إعدادات Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC-RyeNVI6aNmWSJIYhQCG_4J_RQDAovds",
            authDomain: "student-archive-f8689.firebaseapp.com",
            projectId: "student-archive-f8689",
            storageBucket: "student-archive-f8689.appspot.com",
            messagingSenderId: "815104091476",
            appId: "1:815104091476:web:8e725238d8ebabaf26d4c1"
        };

        // تهيئة Firebase بالنسخة المتوافقة (Compat) لضمان العمل في المتصفح
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [students, setStudents] = useState([]);

            // مراقبة حالة تسجيل الدخول
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // جلب البيانات عند تسجيل الدخول
            useEffect(() => {
                if (user) {
                    const unsubscribe = db.collection("students")
                        .orderBy("timestamp", "desc")
                        .onSnapshot((snapshot) => {
                            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setStudents(data);
                        });
                    return () => unsubscribe();
                }
            }, [user]);

            if (loading) return (
                <div className="min-h-screen flex items-center justify-center">
                    <div className="loader rounded-full border-4 h-12 w-12"></div>
                </div>
            );

            if (!user) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100">
                    <div className="bg-white p-8 rounded-xl shadow-lg w-96 text-center">
                        <h2 className="text-2xl font-bold mb-4">تسجيل الدخول</h2>
                        <button 
                            onClick={() => {
                                const email = prompt("أدخل البريد الإلكتروني:");
                                const pass = prompt("أدخل كلمة المرور:");
                                auth.signInWithEmailAndPassword(email, pass).catch(e => alert("خطأ: " + e.message));
                            }}
                            className="w-full bg-sky-500 text-white py-2 rounded-lg font-bold"
                        >
                            دخول النظام
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="p-4 md:p-8">
                    <nav className="flex justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm">
                        <h1 className="text-xl font-bold">فهرس القيد الذكي</h1>
                        <button onClick={() => auth.signOut()} className="text-red-500 font-bold">خروج</button>
                    </nav>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border-r-4 border-sky-500">
                            <p className="text-gray-500">إجمالي الطلاب</p>
                            <h3 className="text-3xl font-bold">{students.length}</h3>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-md overflow-hidden">
                        <table className="w-full text-right">
                            <thead className="bg-slate-50">
                                <tr>
                                    <th className="p-4">الاسم</th>
                                    <th className="p-4">القيد</th>
                                    <th className="p-4">الصفحة</th>
                                </tr>
                            </thead>
                            <tbody>
                                {students.map(s => (
                                    <tr key={s.id} className="border-t hover:bg-slate-50">
                                        <td className="p-4 font-bold">{s.name} {s.surname}</td>
                                        <td className="p-4 font-mono">{s.qaid}</td>
                                        <td className="p-4 font-mono">{s.page}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
