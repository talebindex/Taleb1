<!-- =========================
    Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø°ÙƒÙŠ (Ù…Ø¹Ø¯Ù„)
    ========================= -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø°ÙƒÙŠ</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  query, orderBy, deleteDoc, doc, updateDoc,
  writeBatch, getDocs
} from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword,
  onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC-RyeNVI6aNmWSJIYhQCG_4J_RQDAovds",
  authDomain: "student-archive-f8689.firebaseapp.com",
  projectId: "student-archive-f8689",
  storageBucket: "student-archive-f8689.appspot.com",
  messagingSenderId: "815104091476",
  appId: "1:815104091476:web:8e725238d8ebabaf26d4c1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const studentsCol = collection(db, "students");

window.allStudentsData = [];
let deleteTargetId = null;

/* ================= TOAST ================= */
window.showToast = (msg, type = 'success') => {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = msg;
  c.appendChild(t);
  setTimeout(() => { t.style.opacity = 0; setTimeout(() => t.remove(), 400); }, 3000);
};

/* ================= AUTH ================= */
onAuthStateChanged(auth, user => {
  loginPage.style.display = user ? "none" : "flex";
  appContent.style.display = user ? "block" : "none";
  if (user) loadData();
});

/* ================= LOAD DATA ================= */
function loadData() {
  onSnapshot(query(studentsCol, orderBy("timestamp", "desc")), snap => {
    window.allStudentsData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    applyFilters();
  });
}

/* ================= DUPLICATE CHECK ================= */
function isDuplicateFull(name, qaid, page, list, excludeId = null) {
  return list.some(s =>
    (!excludeId || s.id !== excludeId) &&
    s.name.trim().toLowerCase() === name.trim().toLowerCase() &&
    String(s.qaid).trim() === String(qaid).trim() &&
    String(s.page).trim() === String(page).trim()
  );
}

/* ================= SAVE ================= */
window.saveData = async () => {
  const id = editId.value;
  const name = fName.value.trim();
  const mother = mName.value.trim();
  const qaid = qNum.value.trim();
  const page = pNum.value.trim();

  if (!name || !qaid || !page) {
    showToast("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
    return;
  }

  if (isDuplicateFull(name, qaid, page, window.allStudentsData, id)) {
    showToast("Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ø¨Ù†ÙØ³ Ø§Ù„Ù‚ÙŠØ¯ ÙˆØ§Ù„ØµÙØ­Ø©", "error");
    return;
  }

  const data = {
    name,
    surname: surname.value,
    mother,
    qaid,
    page,
    note: note.value,
    timestamp: Date.now()
  };

  try {
    if (id) await updateDoc(doc(db, "students", id), data);
    else await addDoc(studentsCol, data);

    showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­");
    entryModal.style.display = "none";
  } catch {
    showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸", "error");
  }
};

/* ================= DELETE ================= */
window.del = id => { deleteTargetId = id; deleteModal.style.display = "flex"; };
window.confirmDel = async () => {
  await deleteDoc(doc(db, "students", deleteTargetId));
  deleteModal.style.display = "none";
  showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù", "error");
};

/* ================= FILTER + RENDER ================= */
window.applyFilters = () => {
  render([...window.allStudentsData].sort((a, b) => a.name.localeCompare(b.name, 'ar')));
};

window.render = data => {
  studentsList.innerHTML = "";
  data.forEach(s => {
    studentsList.innerHTML += `
      <div class="card student-item">
        <b>${s.name}</b>
        <small>Ù‚ÙŠØ¯: ${s.qaid} | Øµ: ${s.page}</small>
        <div>
          <button onclick="edit('${s.id}')">âœ</button>
          <button onclick="del('${s.id}')">ğŸ—‘</button>
        </div>
      </div>`;
  });
};

/* ================= PRINT ================= */
function executePrint(data, title) {
  printTitle.innerText = title;
  printTablesContainer.innerHTML = "";

  let html = `
  <table>
    <tr><th>Øª</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‚ÙŠØ¯</th><th>Ø§Ù„ØµÙØ­Ø©</th></tr>
  `;

  data.forEach((s, i) => {
    html += `<tr>
      <td>${i + 1}</td>
      <td>${s.name}</td>
      <td>${s.qaid}</td>
      <td>${s.page}</td>
    </tr>`;
  });

  html += "</table>";
  printTablesContainer.innerHTML = html;

  setTimeout(() => window.print(), 300);
}

window.printAllAlpha = () =>
  executePrint([...window.allStudentsData].sort((a,b)=>a.name.localeCompare(b.name,'ar')), "Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø§Ù…");

/* ================= LOGIN ================= */
window.login = async () => {
  try {
    await signInWithEmailAndPassword(auth, loginEmail.value, loginPass.value);
  } catch {
    showToast("Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©", "error");
  }
};
window.logout = () => signOut(auth);
</script>

<style>
@media print {
  .no-print { display: none }
  table { width: 100%; border-collapse: collapse }
  th, td { border: 1px solid #000; padding: 4px; font-size: 12px }
  th { background: #eee }
}
</style>
</head>

<body>

<div id="toastContainer"></div>

<div id="loginPage">
  <input id="loginEmail" placeholder="Email">
  <input id="loginPass" type="password" placeholder="Password">
  <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="appContent" class="no-print" style="display:none">
  <button onclick="printAllAlpha()">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
  <button onclick="openAddModal()">â• Ø¥Ø¶Ø§ÙØ©</button>
  <div id="studentsList"></div>
</div>

<div class="print-area">
  <h3 id="printTitle"></h3>
  <div id="printTablesContainer"></div>
</div>

</body>
</html>
