<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ar" lang="ar" dir="rtl">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>فهرس القيد - ث. ش. محمد عبدالعزيز الكنعان</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript">
        /* <![CDATA[ */
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#0ea5e9',
                        secondary: '#6366f1',
                        dark: '#0f172a',
                        card: '#1e293b'
                    },
                    fontFamily: {
                        sans: ['Tajawal', 'sans-serif'],
                    }
                }
            }
        }
        /* ]]> */
    </script>

    <!-- Babel for JSX transformation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style type="text/css">
        /* <![CDATA[ */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
        
        body {
            font-family: 'Tajawal', sans-serif;
        }

        /* --- Unified Table Styles for Screen (Preview) and Print --- */
        .print-unified-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            direction: rtl;
        }
        .print-unified-table th, .print-unified-table td {
            border: 1px solid #000;
            padding: 2px 4px;
            vertical-align: middle;
        }
        .print-unified-table th {
            background-color: #f3f4f6 !important;
            padding: 4px;
            font-weight: 800;
            font-size: 12px;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        .print-unified-row {
            height: 28px !important; /* Strict height for both preview and print */
        }
        
        @media print {
            .no-print { display: none !important; }
            
            /* Hide the main app container explicitly to prevent cards from printing */
            nav, main, .stats-cards, .search-bar, #main-app-container { 
                display: none !important; 
            }

            .print-area { display: block !important; }
            
            /* GLOBAL RESET FOR PRINT - CRITICAL FIX */
            body, html, #root {
                width: 100%;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
                background-color: white !important;
            }

            /* Fix Modal Container for Printing */
            .fixed.inset-0.z-50.bg-white {
                position: static !important;
                overflow: visible !important;
                display: block !important;
                height: auto !important;
                width: 100% !important;
                z-index: auto !important;
                background: white !important;
            }

            /* Fix the scrollable content wrapper inside the modal */
            .flex-grow.bg-white.text-black.overflow-auto {
                overflow: visible !important;
                height: auto !important;
                position: static !important;
                display: block !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Ensure text color is black */
            body, * { 
                color: black !important; 
                border-color: black !important; 
            }
            
            /* Page Setup to reduce empty pages */
            @page { 
                margin: 5mm; /* Small margins to prevent overflow */
                size: A4 portrait; 
            }
            
            .print-page {
                page-break-after: always;
                width: 100%;
                height: auto; /* Allow auto height */
                overflow: hidden; /* Cut off anything extra */
                display: block;
                margin-bottom: 0;
            }
            
            .print-page:last-child {
                page-break-after: auto;
                margin-bottom: 0;
            }

            /* Single Slip Print Style */
            .single-slip {
                border: 2px solid #000;
                padding: 20px;
                margin: 20px auto;
                width: 100%;
                max-width: 600px;
                page-break-inside: avoid;
            }
        }

        .loader {
            border-top-color: #0ea5e9;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }

        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .dark ::-webkit-scrollbar-track {
            background: #0f172a;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #334155;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* ]]> */
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react" data-type="module">
    /* <![CDATA[ */
        import React, { useState, useEffect, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import * as XLSX from 'https://esm.sh/xlsx@0.18.5';
        
        // Lucide Icons
        import { 
            User as UserIcon, LogOut, Plus, Search, Trash2, Edit, Copy, Moon, Sun,
            FileSpreadsheet, Printer, FileDown, Upload, Database, Calendar, Users,
            AlertTriangle, Loader2, Settings, X, Check, ChevronLeft, ChevronRight,
            Hash, FileText, Info, Eye, CreditCard, Filter, FolderOpen, Layers, Clock,
            ArrowUpDown, MoreVertical, PlusCircle
        } from 'https://esm.sh/lucide-react@0.263.1';

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, query, orderBy, addDoc, 
            updateDoc, deleteDoc, doc, writeBatch, getDocs, enableIndexedDbPersistence 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { 
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyC-RyeNVI6aNmWSJIYhQCG_4J_RQDAovds",
            authDomain: "student-archive-f8689.firebaseapp.com",
            projectId: "student-archive-f8689",
            storageBucket: "student-archive-f8689.appspot.com",
            messagingSenderId: "815104091476",
            appId: "1:815104091476:web:8e725238d8ebabaf26d4c1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Enable Offline Persistence for Performance
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn('Persistence failed: Multiple tabs open');
            } else if (err.code == 'unimplemented') {
                console.warn('Persistence failed: Browser not supported');
            }
        });

        const auth = getAuth(app);
        const studentsCol = collection(db, "students");

        // --- Types ---
        interface Student {
            id: string;
            name: string;
            surname: string;
            qaid: string;
            page: string;
            note: string;
            timestamp: number;
        }

        type SortOption = 'newest' | 'alpha' | 'surname' | 'qaid' | 'page';

        interface StudentFormData {
            name: string;
            surname: string;
            qaid: string;
            page: string;
            note: string;
        }

        // --- Main App Component ---
        const PAGE_SIZE = 50;

        function App() {
            // Auth State
            const [user, setUser] = useState(null);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [authLoading, setAuthLoading] = useState(true);

            // Data State
            const [students, setStudents] = useState([]);
            const [loading, setLoading] = useState(false);

            // UI State
            const [darkMode, setDarkMode] = useState(false);
            const [toast, setToast] = useState(null);
            const [modalOpen, setModalOpen] = useState(false);
            
            // Print State
            const [printModalOpen, setPrintModalOpen] = useState(false);
            const [printMode, setPrintMode] = useState('menu'); // 'menu' | 'full' | 'single' | 'qaid'
            const [singlePrintSearchTerm, setSinglePrintSearchTerm] = useState('');
            const [singlePrintStudent, setSinglePrintStudent] = useState(null);
            const [targetQaid, setTargetQaid] = useState(''); // For Qaid batch print

            const [settingsOpen, setSettingsOpen] = useState(false);
            const [deleteId, setDeleteId] = useState(null);
            const [masterDeleteOpen, setMasterDeleteOpen] = useState(false);
            const [masterDeleteInput, setMasterDeleteInput] = useState('');
            const [activeRowId, setActiveRowId] = useState(null); // For showing actions

            // Filter State
            const [currentPage, setCurrentPage] = useState(1);
            const [searchTerm, setSearchTerm] = useState('');
            const [sortBy, setSortBy] = useState('newest');
            
            // Advanced Filters
            const [selectedYear, setSelectedYear] = useState('');
            const [selectedMonth, setSelectedMonth] = useState('');
            const [selectedQaidFilter, setSelectedQaidFilter] = useState('');
            const [selectedPageFilter, setSelectedPageFilter] = useState('');

            // Form State
            const [formData, setFormData] = useState({
                name: '', surname: '', qaid: '', page: '', note: ''
            });
            const [editingId, setEditingId] = useState(null);
            const [lastSavedStudent, setLastSavedStudent] = useState(null);
            const [similarStudents, setSimilarStudents] = useState([]);

            const fileInputRef = useRef(null);

            // Initialization (Auth)
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    setAuthLoading(false);
                });
                
                if (localStorage.getItem('theme') === 'dark') {
                    setDarkMode(true);
                    document.documentElement.classList.add('dark');
                }
                return () => unsubscribe();
            }, []);

            // Data Subscription Effect (Optimized)
            useEffect(() => {
                if (user) {
                    const q = query(studentsCol, orderBy("timestamp", "desc"));
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setStudents(data);
                    }, (error) => {
                        console.error("Error fetching students:", error);
                    });
                    return () => unsubscribe();
                } else {
                    setStudents([]);
                }
            }, [user]);

            // Real-time similar name check when adding/editing
            useEffect(() => {
                if (!modalOpen || !formData.name || formData.name.trim().length === 0) {
                    setSimilarStudents([]);
                    return;
                }

                const nameInput = formData.name.trim().toLowerCase();
                const matches = students
                    .filter(s => {
                        // Exclude current student if editing
                        if (editingId && s.id === editingId) return false;
                        // Check if name starts with input
                        return s.name.toLowerCase().startsWith(nameInput);
                    })
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .slice(0, 5); // Limit to 5 suggestions

                setSimilarStudents(matches);
            }, [formData.name, students, modalOpen, editingId]);

            // Helper Functions
            const showToast = (msg, type = 'success') => {
                setToast({ msg, type });
                setTimeout(() => setToast(null), 3000);
            };

            const toggleDarkMode = () => {
                setDarkMode(!darkMode);
                if (!darkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            };

            const resetForm = () => {
                setFormData({ name: '', surname: '', qaid: '', page: '', note: '' });
                setEditingId(null);
                setSimilarStudents([]);
            };

            // Auth Actions
            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    showToast('خطأ في تسجيل الدخول. تأكد من البيانات.', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                await signOut(auth);
                setStudents([]);
                setEmail('');
                setPassword('');
            };

            // CRUD Actions
            const handleSave = async (e) => {
                e.preventDefault();
                if (!formData.name || !formData.qaid || !formData.page) {
                    showToast('يرجى إكمال البيانات الأساسية (الاسم، القيد، الصفحة)', 'error');
                    return;
                }

                // Strict duplicate check (Qaid + Page)
                const isDuplicate = students.some(s => 
                    s.id !== editingId && 
                    s.qaid === formData.qaid && 
                    s.page === formData.page
                );

                if (isDuplicate) {
                    showToast('تنبيه: هذا القيد والصفحة مسجلين مسبقاً لطالب آخر!', 'error');
                    return;
                }

                setLoading(true);
                try {
                    // Use existing timestamp if editing, or new if creating
                    const originalTimestamp = editingId ? (students.find(s => s.id === editingId)?.timestamp || Date.now()) : Date.now();
                    const payload = { ...formData, timestamp: originalTimestamp };
                    
                    if (editingId) {
                        await updateDoc(doc(db, "students", editingId), payload);
                        showToast('تم تحديث بيانات الطالب بنجاح');
                    } else {
                        await addDoc(studentsCol, payload);
                        setLastSavedStudent(formData);
                        showToast('تم إضافة الطالب بنجاح');
                    }
                    setModalOpen(false);
                    resetForm();
                } catch (err) {
                    console.error(err);
                    showToast('حدث خطأ أثناء الحفظ', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleDelete = async () => {
                if (!deleteId) return;
                try {
                    await deleteDoc(doc(db, "students", deleteId));
                    showToast('تم حذف السجل بنجاح', 'success');
                    setDeleteId(null);
                } catch (err) {
                    showToast('فشل في عملية الحذف', 'error');
                }
            };

            const handleMasterDelete = async () => {
                if (masterDeleteInput !== 'حذف الكل') {
                    showToast('كلمة التأكيد غير صحيحة. اكتب "حذف الكل"', 'error');
                    return;
                }
                setLoading(true);
                try {
                    const snapshot = await getDocs(studentsCol);
                    const batch = writeBatch(db);
                    snapshot.docs.forEach((doc) => batch.delete(doc.ref));
                    await batch.commit();
                    showToast('تم مسح جميع البيانات من قاعدة البيانات', 'success');
                    setMasterDeleteOpen(false);
                    setSettingsOpen(false);
                } catch (err) {
                    showToast('حدث خطأ أثناء الحذف الشامل', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleCopyLast = () => {
                if (lastSavedStudent) {
                    setFormData(prev => ({
                        ...prev,
                        qaid: lastSavedStudent.qaid,
                        page: lastSavedStudent.page,
                        note: lastSavedStudent.note
                    }));
                    showToast('تم نسخ بيانات القيد والصفحة من آخر إضافة');
                } else {
                    showToast('لا توجد بيانات سابقة للنسخ', 'error');
                }
            };

            // Excel Actions
            const handleExport = () => {
                const dataToExport = students.map(({id, timestamp, ...rest}) => ({
                    "الاسم": rest.name,
                    "اللقب": rest.surname,
                    "القيد": rest.qaid,
                    "الصفحة": rest.page,
                    "ملاحظات": rest.note,
                    "تاريخ الإضافة": new Date(timestamp).toLocaleDateString('ar-EG')
                }));
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "الطلاب");
                XLSX.writeFile(wb, `ارشيف_الطلاب_${new Date().toISOString().slice(0,10)}.xlsx`);
            };

            const handleImport = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;

                setLoading(true);
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const bstr = evt.target?.result;
                        const wb = XLSX.read(bstr, { type: 'array' });
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        const data = XLSX.utils.sheet_to_json(ws);

                        const batch = writeBatch(db);
                        let count = 0;
                        const timestampBase = Date.now();

                        data.forEach((row, index) => {
                            const name = String(row.name || row["الاسم"] || "").trim();
                            const qaid = String(row.qaid || row["القيد"] || "").trim();
                            const page = String(row.page || row["الصفحة"] || "").trim();
                            const surname = String(row.surname || row["اللقب"] || "").trim();
                            const note = String(row.note || row["ملاحظات"] || "").trim();

                            if (name && qaid && page) {
                                const docRef = doc(studentsCol);
                                batch.set(docRef, {
                                    name, surname, qaid, page, note,
                                    timestamp: timestampBase - index
                                });
                                count++;
                            }
                        });

                        if (count > 0) {
                            await batch.commit();
                            showToast(`تم استيراد ${count} سجل بنجاح`);
                        } else {
                            showToast('لم يتم العثور على بيانات صالحة في الملف', 'error');
                        }
                    } catch (err) {
                        console.error(err);
                        showToast('خطأ في قراءة ملف الإكسل', 'error');
                    } finally {
                        setLoading(false);
                        if (fileInputRef.current) fileInputRef.current.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            // Extract Filter Options
            const availableYears = useMemo(() => {
                const years = new Set(students.map(s => new Date(s.timestamp).getFullYear()));
                return Array.from(years).sort((a, b) => b - a);
            }, [students]);

            const availableQaids = useMemo(() => {
                return [...new Set(students.map(s => s.qaid))].sort((a, b) => a.localeCompare(b));
            }, [students]);

            // Filter & Pagination Logic
            const filteredStudents = useMemo(() => {
                const term = searchTerm.toLowerCase().trim();
                const pageFilter = selectedPageFilter.trim();
                
                let result = students.filter(s => {
                    // Search Logic
                    const matchesSearch = !term || (
                        s.name.toLowerCase().includes(term) ||
                        s.surname.toLowerCase().includes(term) ||
                        s.qaid.includes(term) ||
                        s.page.includes(term) ||
                        s.note.toLowerCase().includes(term)
                    );

                    // Year Filter
                    const date = new Date(s.timestamp);
                    const matchesYear = !selectedYear || date.getFullYear().toString() === selectedYear;

                    // Month Filter
                    const matchesMonth = !selectedMonth || (date.getMonth() + 1).toString() === selectedMonth;

                    // Qaid Filter
                    const matchesQaid = !selectedQaidFilter || s.qaid === selectedQaidFilter;

                    // Page Filter
                    const matchesPage = !pageFilter || s.page.includes(pageFilter);

                    return matchesSearch && matchesYear && matchesMonth && matchesQaid && matchesPage;
                });

                // Custom sorting logic based on search
                result.sort((a, b) => {
                    // If searching, prioritize alphabetical sort for relevant results
                    if (term) {
                        const nameA = a.name.toLowerCase();
                        const nameB = b.name.toLowerCase();
                        const aStarts = nameA.startsWith(term);
                        const bStarts = nameB.startsWith(term);
                        if (aStarts && !bStarts) return -1;
                        if (!aStarts && bStarts) return 1;
                        return nameA.localeCompare(nameB, 'ar');
                    }

                    // Default sorting
                    if (sortBy === 'newest') return b.timestamp - a.timestamp;
                    if (sortBy === 'alpha') return a.name.localeCompare(b.name, 'ar');
                    if (sortBy === 'surname') return (a.surname || '').localeCompare(b.surname || '', 'ar');
                    if (sortBy === 'qaid') return a.qaid.localeCompare(b.qaid);
                    if (sortBy === 'page') return a.page.localeCompare(b.page);
                    return 0;
                });

                return result;
            }, [students, searchTerm, sortBy, selectedYear, selectedMonth, selectedQaidFilter, selectedPageFilter]);

            const totalPages = Math.ceil(filteredStudents.length / PAGE_SIZE);
            const paginatedStudents = useMemo(() => {
                const start = (currentPage - 1) * PAGE_SIZE;
                return filteredStudents.slice(start, start + PAGE_SIZE);
            }, [filteredStudents, currentPage]);

            // Single Print Logic - Search filtered list
            const singlePrintFiltered = useMemo(() => {
                 const term = singlePrintSearchTerm.toLowerCase().trim();
                 if(!term) return [];
                 return students.filter(s => 
                     s.name.toLowerCase().includes(term) || 
                     s.qaid.includes(term)
                 ).slice(0, 5);
            }, [students, singlePrintSearchTerm]);

            // Unique Qaids for Batch Print
            const uniqueQaids = useMemo(() => {
                return [...new Set(students.map(s => s.qaid))].sort((a, b) => a.localeCompare(b));
            }, [students]);

            const qaidBatchFiltered = useMemo(() => {
                const term = singlePrintSearchTerm.toLowerCase().trim();
                return uniqueQaids.filter(q => q.toLowerCase().includes(term));
            }, [uniqueQaids, singlePrintSearchTerm]);

            useEffect(() => {
                setCurrentPage(1);
            }, [searchTerm, sortBy, selectedYear, selectedMonth, selectedQaidFilter, selectedPageFilter]);

            // UI Render
            if (authLoading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50 dark:bg-slate-900">
                        <div className="text-center">
                            <div className="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
                            <p className="text-gray-500 dark:text-gray-400">جاري التحميل...</p>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-900 dark:to-slate-800 p-4">
                        <div className="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-200 dark:border-slate-700">
                            <div className="text-center mb-8">
                                <div className="bg-primary/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-primary">
                                    <Database size={32} />
                                </div>
                                <h1 className="text-xl md:text-2xl font-bold text-slate-800 dark:text-white leading-relaxed px-4">
                                    فهرس القيد. <br/> ث. ش. محمد عبدالعزيز الكنعان للبنين
                                </h1>
                                <p className="text-slate-500 dark:text-slate-400 mt-2">يرجى تسجيل الدخول للمتابعة</p>
                            </div>
                            
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1 text-slate-700 dark:text-slate-300">البريد الإلكتروني</label>
                                    <input 
                                        type="email" 
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="w-full p-3 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
                                        placeholder="admin@example.com"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1 text-slate-700 dark:text-slate-300">كلمة المرور</label>
                                    <input 
                                        type="password" 
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full p-3 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
                                        placeholder="••••••••"
                                        required
                                    />
                                </div>
                                <button 
                                    type="submit" 
                                    disabled={loading}
                                    className="w-full bg-primary hover:bg-sky-600 text-white py-3 rounded-lg font-bold transition-colors shadow-lg shadow-primary/30 flex items-center justify-center gap-2"
                                >
                                    {loading ? <Loader2 className="animate-spin" /> : <UserIcon size={20} />}
                                    تسجيل الدخول
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            // Print Table Component Helper - UPDATED: Uses unified CSS class for exact match
            const PrintTable = ({ data, startIndex, rowsPerCol }) => {
                // Fill data to ensure equal height
                const filledData = [...(Array.isArray(data) ? data : [])];
                const emptyRowsCount = Math.max(0, rowsPerCol - filledData.length);
                for (let i = 0; i < emptyRowsCount; i++) {
                    filledData.push({ isEmpty: true });
                }

                return (
                    <table className="print-unified-table">
                        <thead>
                            <tr className="bg-gray-100">
                                <th className="text-right w-full">الاسم الكامل</th>
                                <th className="text-center whitespace-nowrap w-min">ق</th>
                                <th className="text-center whitespace-nowrap w-min">ص</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filledData.map((s, idx) => {
                                if (s.isEmpty) {
                                    return (
                                        <tr key={`empty-${idx}`} className="print-unified-row">
                                            <td>&nbsp;</td>
                                            <td>&nbsp;</td>
                                            <td>&nbsp;</td>
                                        </tr>
                                    );
                                }

                                // Clean Name: Remove extra internal spaces and combine
                                const rawName = `${s.name} ${s.surname}`;
                                const fullName = rawName.replace(/\s+/g, ' ').trim();
                                
                                // Font size logic: Optimized for 11px base
                                let nameStyle = { fontSize: '11px', fontWeight: '700' };
                                if (fullName.length > 25) nameStyle = { fontSize: '10px', fontWeight: '600', lineHeight: '1.2' };
                                if (fullName.length > 38) nameStyle = { fontSize: '9px', fontWeight: '600', lineHeight: '1.1' };

                                return (
                                    <tr key={s.id || idx} className="print-unified-row">
                                        <td className="px-1 font-bold whitespace-normal leading-tight" style={nameStyle}>
                                            <span className="ml-1 font-normal text-gray-500 text-[9px] mr-1 inline-block min-w-[15px]">{startIndex + idx + 1}.</span>
                                            {fullName}
                                        </td>
                                        <td className="text-center font-mono font-bold whitespace-nowrap px-1 text-[11px]">{s.qaid}</td>
                                        <td className="text-center font-mono font-bold whitespace-nowrap px-1 text-[11px]">{s.page}</td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                );
            };

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 flex flex-col transition-colors duration-300">
                    {/* Navbar */}
                    <nav className="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 sticky top-0 z-30 shadow-sm no-print">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16">
                                <div className="flex items-center gap-3">
                                    <img src="https://i.imgur.com/05ANc5p.png" alt="شعار" className="h-10 w-auto object-contain" />
                                    <div className="flex flex-col justify-center">
                                        <span className="font-bold text-base md:text-lg leading-tight text-slate-800 dark:text-white">فهرس القيد الذكي</span>
                                        <span className="text-xs md:text-sm text-slate-500 dark:text-slate-400">ث. ش. محمد عبدالعزيز الكنعان</span>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2 sm:gap-4">
                                    
                                    {/* Settings and Print Buttons - Kept here */}
                                    <div className="flex items-center gap-1 sm:gap-2">
                                        
                                        <button 
                                            onClick={() => { 
                                                setPrintMode('menu'); 
                                                setSinglePrintStudent(null); 
                                                setSinglePrintSearchTerm('');
                                                setTargetQaid('');
                                                setPrintModalOpen(true); 
                                            }}
                                            className="bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 p-2 sm:px-3 sm:py-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors border border-slate-200 dark:border-slate-600 flex items-center gap-1 sm:gap-2"
                                            title="طباعة"
                                        >
                                            <Printer size={18} />
                                            <span className="hidden sm:inline text-sm">طباعة</span>
                                        </button>

                                        <button 
                                            onClick={() => setSettingsOpen(true)}
                                            className="bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors border border-slate-200 dark:border-slate-600"
                                            title="الإعدادات"
                                        >
                                            <Settings size={18} />
                                        </button>
                                    </div>

                                    <div className="h-6 w-px bg-slate-300 dark:bg-slate-600 mx-1"></div>
                                    <div className="flex items-center gap-3">
                                        <span className="text-sm font-medium hidden lg:block">{user.email}</span>
                                        <button 
                                            onClick={handleLogout}
                                            className="flex items-center gap-2 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 px-3 py-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors text-sm font-bold"
                                            title="خروج"
                                        >
                                            <LogOut size={18} />
                                            <span className="hidden sm:inline">خروج</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </nav>

                    {/* Main Content */}
                    <main className="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full print-area">
                        {/* Stats Cards */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 no-print">
                            {/* Card 1: Total */}
                            <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-between">
                                <div className="bg-primary text-white text-xl font-bold px-4 py-2 rounded-lg shadow-sm min-w-[60px] text-center">
                                    {students.length}
                                </div>
                                <div className="text-blue-500 bg-blue-50 dark:bg-blue-900/20 p-2 rounded-full">
                                    <Users size={20} />
                                </div>
                            </div>

                            {/* Card 2: Unique Qaids */}
                            <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-between">
                                <div>
                                    <p className="text-xs text-slate-500 font-bold mb-1">القيود</p>
                                    <h3 className="text-lg font-bold">{new Set(students.map(s => s.qaid)).size}</h3>
                                </div>
                                <div className="text-purple-500 bg-purple-50 dark:bg-purple-900/20 p-2 rounded-full">
                                    <Hash size={20} />
                                </div>
                            </div>

                            {/* Card 3: Unique Pages */}
                            <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-between">
                                <div>
                                    <p className="text-xs text-slate-500 font-bold mb-1">الصفحات</p>
                                    <h3 className="text-lg font-bold">{new Set(students.map(s => s.page)).size}</h3>
                                </div>
                                <div className="text-yellow-500 bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded-full">
                                    <FileText size={20} />
                                </div>
                            </div>

                            {/* Card 4: Latest */}
                            <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-between">
                                <div className="overflow-hidden">
                                    <p className="text-xs text-slate-500 font-bold mb-1">الأحدث</p>
                                    <h3 className="text-sm font-bold truncate">
                                        {students[0]?.name || '-'}
                                    </h3>
                                </div>
                                <div className="text-green-500 bg-green-50 dark:bg-green-900/20 p-2 rounded-full">
                                    <Calendar size={20} />
                                </div>
                            </div>
                        </div>

                        {/* Beautiful Add Student Card Button */}
                        <div 
                            onClick={() => { resetForm(); setModalOpen(true); }}
                            className="mb-6 cursor-pointer group no-print"
                        >
                            <div className="bg-gradient-to-r from-sky-500 to-indigo-600 rounded-2xl p-6 text-white shadow-lg hover:shadow-2xl hover:shadow-indigo-500/20 transition-all duration-300 transform hover:-translate-y-1 relative overflow-hidden">
                                <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-16 -mt-16 blur-3xl group-hover:bg-white/20 transition-all"></div>
                                <div className="relative flex items-center justify-between">
                                    <div className="flex items-center gap-6">
                                        <div className="bg-white/20 p-4 rounded-full backdrop-blur-sm group-hover:scale-110 transition-transform duration-300">
                                            <Plus size={32} className="text-white" />
                                        </div>
                                        <div>
                                            <h2 className="text-2xl font-bold mb-1">إضافة طالب جديد</h2>
                                            <p className="text-indigo-100 text-sm opacity-90">انقر هنا لفتح نموذج تسجيل طالب جديد في الأرشيف</p>
                                        </div>
                                    </div>
                                    <div className="bg-white/20 p-2 rounded-lg backdrop-blur-sm hidden sm:block group-hover:bg-white/30 transition-colors">
                                        <ChevronLeft size={24} />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Search Toolbar (Sticky) */}
                        <div className="sticky top-16 z-20 bg-slate-50/95 dark:bg-slate-900/95 backdrop-blur-sm py-4 -mx-4 px-4 border-b border-slate-200 dark:border-slate-800 transition-colors duration-300 mb-4 no-print shadow-sm">
                            <div className="relative w-full">
                                <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400" size={20} />
                                <input
                                    type="text"
                                    placeholder="بحث شامل (الاسم، الملاحظات)..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full pl-4 pr-10 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 focus:ring-2 focus:ring-primary focus:border-transparent outline-none shadow-sm"
                                />
                            </div>
                        </div>

                        {/* Filters Row */}
                        <div className="flex flex-wrap items-center gap-2 w-full justify-end mb-6 no-print">
                            <div className="flex items-center bg-white dark:bg-slate-800 rounded-lg border border-slate-300 dark:border-slate-600 p-1 shadow-sm">
                                <Filter size={16} className="mx-2 text-slate-400" />
                                
                                {/* Sort By Dropdown */}
                                <div className="flex items-center gap-1 border-l border-slate-300 dark:border-slate-600 pl-2 ml-1">
                                    <ArrowUpDown size={14} className="text-slate-400" />
                                    <select 
                                        value={sortBy}
                                        onChange={(e) => setSortBy(e.target.value)}
                                        className="bg-transparent border-none text-sm focus:ring-0 p-1.5 text-slate-700 dark:text-slate-200 outline-none cursor-pointer font-medium"
                                    >
                                        <option value="newest">الأحدث أولاً</option>
                                        <option value="alpha">أبجدي (أ-ي)</option>
                                        <option value="qaid">حسب القيد</option>
                                    </select>
                                </div>
                                <div className="w-px h-4 bg-slate-300 dark:bg-slate-600 mx-1"></div>

                                {/* Year Filter */}
                                <select 
                                    value={selectedYear}
                                    onChange={(e) => setSelectedYear(e.target.value)}
                                    className="bg-transparent border-none text-sm focus:ring-0 p-1.5 text-slate-700 dark:text-slate-200 outline-none cursor-pointer"
                                >
                                    <option value="">السنة (الكل)</option>
                                    {availableYears.map(year => (
                                        <option key={year} value={year}>{year}</option>
                                    ))}
                                </select>
                                <div className="w-px h-4 bg-slate-300 dark:bg-slate-600 mx-1"></div>
                                
                                {/* Month Filter */}
                                <select 
                                    value={selectedMonth}
                                    onChange={(e) => setSelectedMonth(e.target.value)}
                                    className="bg-transparent border-none text-sm focus:ring-0 p-1.5 text-slate-700 dark:text-slate-200 outline-none cursor-pointer"
                                >
                                    <option value="">الشهر (الكل)</option>
                                    {Array.from({length: 12}, (_, i) => i + 1).map(m => (
                                        <option key={m} value={m}>{m}</option>
                                    ))}
                                </select>
                            </div>

                            {/* Qaid & Page Filter */}
                            <div className="flex gap-2 flex-grow md:flex-grow-0">
                                <select 
                                    value={selectedQaidFilter}
                                    onChange={(e) => setSelectedQaidFilter(e.target.value)}
                                    className="flex-grow md:w-40 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-sm rounded-lg p-2.5 text-slate-700 dark:text-slate-200 outline-none focus:ring-2 focus:ring-primary shadow-sm cursor-pointer"
                                >
                                    <option value="">فلتر القيد (الكل)</option>
                                    {availableQaids.map(qaid => (
                                        <option key={qaid} value={qaid}>{qaid}</option>
                                    ))}
                                </select>
                                
                                {/* NEW Page Filter Input */}
                                <input
                                    type="text"
                                    placeholder="ص.."
                                    value={selectedPageFilter}
                                    onChange={(e) => setSelectedPageFilter(e.target.value)}
                                    className="w-16 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-sm rounded-lg p-2.5 text-slate-700 dark:text-slate-200 outline-none focus:ring-2 focus:ring-primary shadow-sm text-center"
                                />
                            </div>
                            
                            {/* Clear Filters */}
                            {(selectedYear || selectedMonth || selectedQaidFilter || selectedPageFilter) && (
                                <button 
                                    onClick={() => {
                                        setSelectedYear('');
                                        setSelectedMonth('');
                                        setSelectedQaidFilter('');
                                        setSelectedPageFilter('');
                                    }}
                                    className="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 p-2 rounded-lg text-sm font-medium transition-colors"
                                >
                                    مسح الفلاتر
                                </button>
                            )}
                        </div>

                        {/* Loading Overlay */}
                        {loading && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center no-print">
                                <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-2xl flex flex-col items-center">
                                    <Loader2 className="animate-spin text-primary mb-3" size={32} />
                                    <p className="text-slate-700 dark:text-slate-200 font-medium">جاري المعالجة...</p>
                                </div>
                            </div>
                        )}

                        {/* Data List (Reverted to Avatar Style) */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 pb-12">
                            {paginatedStudents.length === 0 ? (
                                <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-12 text-center text-slate-500 dark:text-slate-400 col-span-1 lg:col-span-2">
                                    <div className="flex flex-col items-center justify-center">
                                        <Search size={48} className="mb-4 opacity-20" />
                                        <p className="text-lg">لا توجد نتائج مطابقة</p>
                                        <p className="text-sm mt-1">حاول البحث بكلمات مختلفة أو تغيير الفلاتر</p>
                                    </div>
                                </div>
                            ) : (
                                paginatedStudents.map((student, index) => {
                                    const globalIndex = (currentPage - 1) * PAGE_SIZE + index + 1;
                                    return (
                                        <div 
                                            key={student.id} 
                                            // UPDATED: Added z-index logic to show popup over other cards
                                            className={`bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-4 hover:shadow-md transition-shadow relative group ${activeRowId === student.id ? 'z-20' : 'z-0'}`}
                                            style={{ zIndex: activeRowId === student.id ? 20 : 'auto' }}
                                            onClick={() => setActiveRowId(activeRowId === student.id ? null : student.id)}
                                        >
                                            <div className="flex items-start justify-between">
                                                <div className="flex items-start gap-4">
                                                    {/* Avatar */}
                                                    <div className="hidden sm:flex h-12 w-12 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white items-center justify-center text-lg font-bold shadow-md shrink-0 border-2 border-white dark:border-slate-700 ring-1 ring-blue-200 dark:ring-blue-900 mt-1">
                                                        {student.name.charAt(0)}
                                                    </div>

                                                    <div className="flex flex-col gap-1">
                                                        {/* Line 1: Full Name */}
                                                        <div className="flex items-center gap-2">
                                                            <span className="bg-slate-100 dark:bg-slate-700 text-slate-500 text-[10px] font-mono px-1.5 rounded">{globalIndex}</span>
                                                            <h3 className="text-lg font-bold text-slate-900 dark:text-white group-hover:text-primary transition-colors">
                                                                {student.name} / {student.surname}
                                                            </h3>
                                                        </div>

                                                        {/* Line 2: Details Row */}
                                                        <div className="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-slate-600 dark:text-slate-300 mt-2">
                                                            {/* Qaid Badge - Specific Color */}
                                                            <div className="flex items-center gap-2 px-4 py-1 rounded-full shadow-sm transition-transform hover:scale-105" style={{ backgroundColor: '#893BFF' }}>
                                                                <span className="font-bold text-white text-sm">ق</span>
                                                                <div className="w-px h-4 bg-white/30"></div>
                                                                <span className="font-mono font-bold text-white text-lg tracking-wider">{student.qaid}</span>
                                                            </div>
                                                            
                                                            {/* Page Badge - Specific Color */}
                                                            <div className="flex items-center gap-2 px-4 py-1 rounded-full shadow-sm transition-transform hover:scale-105" style={{ backgroundColor: '#FFE87C' }}>
                                                                <span className="font-bold text-slate-800 text-sm">ص</span>
                                                                <div className="w-px h-4 bg-slate-800/20"></div>
                                                                <span className="font-mono font-bold text-slate-900 text-base">{student.page}</span>
                                                            </div>

                                                            <div className="flex items-center gap-1.5 bg-slate-50 dark:bg-slate-700/50 px-2 py-1 rounded-md border border-slate-100 dark:border-slate-700 h-full">
                                                                <Clock size={14} className="text-slate-400" />
                                                                <span className="text-xs">{new Date(student.timestamp).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Notes if exist */}
                                                        {student.note && (
                                                            <p className="text-xs text-slate-500 dark:text-slate-400 mt-2 border-t border-slate-100 dark:border-slate-700 pt-2 flex items-center gap-1">
                                                                <Info size={12} />
                                                                {student.note}
                                                            </p>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* Action Trigger Icon (Visible on Desktop) */}
                                                <button 
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setActiveRowId(activeRowId === student.id ? null : student.id);
                                                    }}
                                                    className="text-slate-300 group-hover:text-primary cursor-pointer transition-colors p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 outline-none focus:ring-2 focus:ring-primary"
                                                    title="إعدادات البطاقة"
                                                >
                                                    <Settings size={20} />
                                                </button>
                                            </div>

                                            {/* Actions Floating Popup */}
                                            {activeRowId === student.id && (
                                                <div className="absolute left-4 top-12 flex items-center gap-1 animate-in fade-in slide-in-from-top-2 duration-200 z-50 bg-slate-800 text-white p-1.5 rounded-lg shadow-xl border border-slate-700">
                                                    <button 
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            setSinglePrintStudent(student);
                                                            setPrintMode('single');
                                                            setPrintModalOpen(true);
                                                        }}
                                                        className="p-1.5 hover:bg-slate-700 rounded transition-colors"
                                                        title="طباعة"
                                                    >
                                                        <Printer size={16} />
                                                    </button>
                                                    <div className="w-px h-3 bg-slate-600"></div>
                                                    <button 
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            setFormData({
                                                                name: student.name,
                                                                surname: student.surname,
                                                                qaid: student.qaid,
                                                                page: student.page,
                                                                note: student.note
                                                            });
                                                            setEditingId(student.id);
                                                            setModalOpen(true);
                                                        }}
                                                        className="p-1.5 hover:bg-blue-600/50 rounded transition-colors text-blue-300"
                                                        title="تعديل"
                                                    >
                                                        <Edit size={16} />
                                                    </button>
                                                    <button 
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            setDeleteId(student.id);
                                                        }}
                                                        className="p-1.5 hover:bg-red-600/50 rounded transition-colors text-red-300"
                                                        title="حذف"
                                                    >
                                                        <Trash2 size={16} />
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })
                            )}
                        </div>
                            
                        {/* Pagination */}
                        {totalPages > 1 && (
                            <div className="py-4 flex items-center justify-between no-print bg-white dark:bg-slate-800 rounded-lg p-4 shadow-sm border border-slate-200 dark:border-slate-700">
                                <span className="text-sm text-slate-500 dark:text-slate-400">
                                    صفحة {currentPage} من {totalPages}
                                </span>
                                <div className="flex gap-2 items-center">
                                    <button
                                        onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
                                        disabled={currentPage === 1}
                                        className="p-2 rounded-lg border border-slate-300 dark:border-slate-600 disabled:opacity-50 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
                                    >
                                        <ChevronRight size={20} />
                                    </button>
                                    
                                    {/* Page Selector */}
                                    <select
                                        value={currentPage}
                                        onChange={(e) => setCurrentPage(Number(e.target.value))}
                                        className="h-full py-2 px-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-sm focus:ring-2 focus:ring-primary outline-none cursor-pointer text-center min-w-[3rem]"
                                        title="انتقل للصفحة"
                                    >
                                        {Array.from({length: totalPages}, (_, i) => i + 1).map(num => (
                                            <option key={num} value={num}>{num}</option>
                                        ))}
                                    </select>

                                    <button
                                        onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
                                        disabled={currentPage === totalPages}
                                        className="p-2 rounded-lg border border-slate-300 dark:border-slate-600 disabled:opacity-50 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
                                    >
                                        <ChevronLeft size={20} />
                                    </button>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Modals */}
                    {/* Add/Edit Student Modal */}
                    {modalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                            <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
                                <div className="p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                                    <h2 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                        {editingId ? <Edit size={24} className="text-blue-500" /> : <Plus size={24} className="text-green-500" />}
                                        {editingId ? 'تعديل بيانات طالب' : 'إضافة طالب جديد'}
                                    </h2>
                                    <button onClick={() => { setModalOpen(false); resetForm(); }} className="text-slate-500 hover:text-red-500 transition-colors">
                                        <X size={24} />
                                    </button>
                                </div>
                                
                                <form onSubmit={handleSave} className="p-6 overflow-y-auto custom-scrollbar space-y-4">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="space-y-1">
                                            <label className="text-sm font-bold text-slate-700 dark:text-slate-300">الاسم <span className="text-red-500">*</span></label>
                                            <input
                                                required
                                                type="text"
                                                value={formData.name}
                                                onChange={e => setFormData({...formData, name: e.target.value})}
                                                className="w-full p-3 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-primary outline-none transition-all"
                                                placeholder="اسم الطالب"
                                            />
                                            {/* Similar Students Warning */}
                                            {similarStudents.length > 0 && (
                                                <div className="mt-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg animate-in slide-in-from-top-2">
                                                    <p className="text-xs text-yellow-700 dark:text-yellow-400 font-bold mb-1 flex items-center gap-1">
                                                        <Info size={12} /> أسماء مشابهة مسجلة:
                                                    </p>
                                                    <ul className="space-y-1">
                                                        {similarStudents.map(s => (
                                                            <li key={s.id} className="text-xs text-slate-600 dark:text-slate-400 flex justify-between border-b border-yellow-100 dark:border-yellow-900/50 last:border-0 pb-0.5">
                                                                <span>{s.name}</span>
                                                                <span className="font-mono text-[10px]">(قيد: {s.qaid} | صفحة: {s.page})</span>
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            )}
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-sm font-bold text-slate-700 dark:text-slate-300">اللقب</label>
                                            <input
                                                type="text"
                                                value={formData.surname}
                                                onChange={e => setFormData({...formData, surname: e.target.value})}
                                                className="w-full p-3 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-primary outline-none transition-all"
                                                placeholder="اللقب"
                                            />
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-50 dark:bg-slate-700/30 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                                        <div className="space-y-1">
                                            <label className="text-sm font-bold text-slate-700 dark:text-slate-300">رقم القيد <span className="text-red-500">*</span></label>
                                            <input
                                                required
                                                type="text"
                                                value={formData.qaid}
                                                onChange={e => setFormData({...formData, qaid: e.target.value})}
                                                className="w-full p-3 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 focus:ring-2 focus:ring-primary outline-none font-mono"
                                                placeholder="0000"
                                            />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-sm font-bold text-slate-700 dark:text-slate-300">رقم الصفحة <span className="text-red-500">*</span></label>
                                            <input
                                                required
                                                type="text"
                                                value={formData.page}
                                                onChange={e => setFormData({...formData, page: e.target.value})}
                                                className="w-full p-3 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 focus:ring-2 focus:ring-primary outline-none font-mono"
                                                placeholder="000"
                                            />
                                        </div>
                                        {!editingId && lastSavedStudent && (
                                            <div className="md:col-span-2">
                                                <button 
                                                    type="button"
                                                    onClick={handleCopyLast}
                                                    className="text-xs flex items-center gap-1 text-primary hover:text-primary/80 font-medium"
                                                >
                                                    <Copy size={14} />
                                                    نسخ القيد والصفحة من الإدخال السابق
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    <div className="space-y-1">
                                        <label className="text-sm font-bold text-slate-700 dark:text-slate-300">ملاحظات</label>
                                        <textarea
                                            rows={3}
                                            value={formData.note}
                                            onChange={e => setFormData({...formData, note: e.target.value})}
                                            className="w-full p-3 rounded-lg border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 focus:ring-2 focus:ring-primary outline-none resize-none"
                                            placeholder="أي ملاحظات إضافية..."
                                        ></textarea>
                                    </div>

                                    <div className="pt-4 flex items-center justify-end gap-3">
                                        <button 
                                            type="button" 
                                            onClick={() => { setModalOpen(false); resetForm(); }}
                                            className="px-6 py-2.5 rounded-lg border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors font-medium"
                                        >
                                            إلغاء
                                        </button>
                                        <button 
                                            type="submit" 
                                            disabled={loading}
                                            className="px-6 py-2.5 rounded-lg bg-primary hover:bg-sky-600 text-white shadow-lg shadow-primary/25 transition-all font-bold flex items-center gap-2"
                                        >
                                            {loading ? <Loader2 className="animate-spin" size={18} /> : <Check size={18} />}
                                            {editingId ? 'حفظ التغييرات' : 'إضافة الطالب'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Delete Confirmation */}
                    {deleteId && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
                                <div className="bg-red-100 dark:bg-red-900/30 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 dark:text-red-500">
                                    <AlertTriangle size={32} />
                                </div>
                                <h3 className="text-xl font-bold mb-2">هل أنت متأكد؟</h3>
                                <p className="text-slate-500 dark:text-slate-400 mb-6">لا يمكن التراجع عن عملية الحذف هذه.</p>
                                <div className="flex gap-3 justify-center">
                                    <button 
                                        onClick={() => setDeleteId(null)}
                                        className="px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700"
                                    >
                                        إلغاء
                                    </button>
                                    <button 
                                        onClick={handleDelete}
                                        className="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold shadow-lg shadow-red-600/30"
                                    >
                                        نعم، احذف
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Print View Modal */}
                    {printModalOpen && (
                        <div className="fixed inset-0 z-50 bg-white flex flex-col">
                            {/* Toolbar (No Print) */}
                            <div className="no-print p-4 border-b flex justify-between items-center bg-slate-100">
                                <h2 className="text-lg font-bold">
                                    {printMode === 'menu' ? 'خيارات الطباعة' : 
                                     printMode === 'single' ? 'طباعة قيد طالب محدد' : 
                                     printMode === 'qaid' ? 'طباعة حسب القيد' : 'معاينة الطباعة (السجل الكامل)'}
                                </h2>
                                <div className="flex gap-2">
                                    {(printMode === 'full' || (printMode === 'single' && singlePrintStudent) || (printMode === 'qaid' && targetQaid)) && (
                                        // UPDATED: Print Button Logic wrapped in setTimeout to ensure execution
                                        <button 
                                            onClick={() => setTimeout(() => window.print(), 10)} 
                                            className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-700 transition-colors"
                                        >
                                            <Printer size={18} /> طباعة
                                        </button>
                                    )}
                                    <button onClick={() => setPrintModalOpen(false)} className="bg-slate-300 text-black px-4 py-2 rounded-lg hover:bg-slate-400 transition-colors">إغلاق</button>
                                </div>
                            </div>
                            
                            {/* Printable Content */}
                            <div className="flex-grow bg-white text-black overflow-auto relative">
                                {/* Mode Selection Menu */}
                                {printMode === 'menu' && (
                                    <div className="absolute inset-0 flex items-center justify-center bg-slate-50 overflow-y-auto p-4">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-6xl w-full">
                                            <button 
                                                onClick={() => setPrintMode('full')}
                                                className="flex flex-col items-center justify-center p-8 bg-white border-2 border-slate-200 rounded-2xl hover:border-primary hover:shadow-xl transition-all gap-4 group h-64"
                                            >
                                                <div className="p-4 bg-blue-50 text-blue-600 rounded-full group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                                    <FileSpreadsheet size={48} />
                                                </div>
                                                <h3 className="text-xl font-bold text-slate-800">طباعة السجل بالكامل</h3>
                                                <p className="text-slate-500 text-center text-sm">طباعة جدول يحتوي على جميع الطلاب (مقسم على صفحات)</p>
                                            </button>

                                            <button 
                                                onClick={() => setPrintMode('single')}
                                                className="flex flex-col items-center justify-center p-8 bg-white border-2 border-slate-200 rounded-2xl hover:border-purple-500 hover:shadow-xl transition-all gap-4 group h-64"
                                            >
                                                <div className="p-4 bg-purple-50 text-purple-600 rounded-full group-hover:bg-purple-600 group-hover:text-white transition-colors">
                                                    <CreditCard size={48} />
                                                </div>
                                                <h3 className="text-xl font-bold text-slate-800">بطاقة طالب مفردة</h3>
                                                <p className="text-slate-500 text-center text-sm">البحث عن طالب وطباعة بطاقة قيد فردية له</p>
                                            </button>

                                            <button 
                                                onClick={() => setPrintMode('qaid')}
                                                className="flex flex-col items-center justify-center p-8 bg-white border-2 border-slate-200 rounded-2xl hover:border-orange-500 hover:shadow-xl transition-all gap-4 group h-64"
                                            >
                                                <div className="p-4 bg-orange-50 text-orange-600 rounded-full group-hover:bg-orange-600 group-hover:text-white transition-colors">
                                                    <FolderOpen size={48} />
                                                </div>
                                                <h3 className="text-xl font-bold text-slate-800">طباعة قيد كامل</h3>
                                                <p className="text-slate-500 text-center text-sm">طباعة قائمة بجميع الطلاب المسجلين تحت رقم قيد معين</p>
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {/* Single Print Search Mode */}
                                {printMode === 'single' && !singlePrintStudent && (
                                    <div className="absolute inset-0 flex flex-col items-center justify-start pt-20 bg-slate-50">
                                        <h3 className="text-2xl font-bold mb-6 text-slate-800">ابحث عن الطالب للطباعة</h3>
                                        <div className="w-full max-w-md relative mb-8">
                                            <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                            <input 
                                                autoFocus
                                                type="text" 
                                                className="w-full p-4 pr-12 rounded-xl border-2 border-slate-300 focus:border-purple-500 outline-none text-lg shadow-sm"
                                                placeholder="اكتب اسم الطالب أو رقم القيد..."
                                                value={singlePrintSearchTerm}
                                                onChange={(e) => setSinglePrintSearchTerm(e.target.value)}
                                            />
                                        </div>
                                        <div className="w-full max-w-md space-y-2 max-h-[50vh] overflow-y-auto">
                                            {singlePrintFiltered.map(s => (
                                                <div 
                                                    key={s.id} 
                                                    onClick={() => setSinglePrintStudent(s)}
                                                    className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 cursor-pointer hover:border-purple-500 hover:shadow-md transition-all flex justify-between items-center group"
                                                >
                                                    <div>
                                                        <h4 className="font-bold text-lg group-hover:text-purple-600 transition-colors">{s.name} {s.surname}</h4>
                                                        <p className="text-slate-500 text-sm">قيد: {s.qaid}</p>
                                                    </div>
                                                    <Printer className="text-slate-300 group-hover:text-purple-600" />
                                                </div>
                                            ))}
                                            {singlePrintSearchTerm && singlePrintFiltered.length === 0 && (
                                                <p className="text-center text-slate-500 mt-4">لا توجد نتائج مطابقة</p>
                                            )}
                                        </div>
                                        <button 
                                            onClick={() => setPrintMode('menu')}
                                            className="mt-8 text-slate-500 hover:text-slate-800 underline"
                                        >
                                            العودة للقائمة الرئيسية
                                        </button>
                                    </div>
                                )}

                                {/* Qaid Batch Selection Mode */}
                                {printMode === 'qaid' && !targetQaid && (
                                    <div className="absolute inset-0 flex flex-col items-center justify-start pt-20 bg-slate-50">
                                        <h3 className="text-2xl font-bold mb-6 text-slate-800">اختر رقم القيد للطباعة</h3>
                                        <div className="w-full max-w-md relative mb-8">
                                            <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                            <input 
                                                autoFocus
                                                type="text" 
                                                className="w-full p-4 pr-12 rounded-xl border-2 border-slate-300 focus:border-orange-500 outline-none text-lg shadow-sm"
                                                placeholder="ابحث عن رقم القيد..."
                                                value={singlePrintSearchTerm}
                                                onChange={(e) => setSinglePrintSearchTerm(e.target.value)}
                                            />
                                        </div>
                                        <div className="w-full max-w-md space-y-2 max-h-[50vh] overflow-y-auto custom-scrollbar p-2">
                                            {qaidBatchFiltered.map(qaid => (
                                                <div 
                                                    key={qaid} 
                                                    onClick={() => setTargetQaid(qaid)}
                                                    className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 cursor-pointer hover:border-orange-500 hover:shadow-md transition-all flex justify-between items-center group"
                                                >
                                                    <div className="flex items-center gap-3">
                                                        <div className="bg-orange-100 text-orange-600 p-2 rounded-lg">
                                                            <FolderOpen size={20} />
                                                        </div>
                                                        <div>
                                                            <h4 className="font-bold text-lg text-slate-800 font-mono">{qaid}</h4>
                                                            <p className="text-slate-500 text-xs">
                                                                {students.filter(s => s.qaid === qaid).length} طالب
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <Printer className="text-slate-300 group-hover:text-orange-600" />
                                                </div>
                                            ))}
                                            {singlePrintSearchTerm && qaidBatchFiltered.length === 0 && (
                                                <p className="text-center text-slate-500 mt-4">رقم القيد غير موجود</p>
                                            )}
                                        </div>
                                        <button 
                                            onClick={() => setPrintMode('menu')}
                                            className="mt-8 text-slate-500 hover:text-slate-800 underline"
                                        >
                                            العودة للقائمة الرئيسية
                                        </button>
                                    </div>
                                )}

                                <div className="print-area">
                                    {printMode === 'single' && singlePrintStudent ? (
                                        // Single Student Print View
                                        <div className="single-slip flex flex-col items-center justify-center p-8 border-2 border-black m-8 max-w-2xl mx-auto rounded-xl">
                                            <div className="text-center mb-8 border-b-2 border-black w-full pb-4">
                                                <h1 className="text-2xl font-extrabold mb-2">ث. ش. محمد عبدالعزيز الكنعان للبنين</h1>
                                                <h2 className="text-xl">بطاقة قيد طالب</h2>
                                            </div>
                                            
                                            <div className="w-full grid grid-cols-1 gap-6 text-right" dir="rtl">
                                                <div className="flex border-b border-gray-300 pb-2">
                                                    <span className="font-bold w-32 text-lg">الاسم الكامل:</span>
                                                    <span className="text-xl flex-grow font-bold">{singlePrintStudent.name} {singlePrintStudent.surname}</span>
                                                </div>
                                                <div className="flex border-b border-gray-300 pb-2">
                                                    <span className="font-bold w-32 text-lg">رقم القيد:</span>
                                                    <span className="text-xl font-mono">{singlePrintStudent.qaid}</span>
                                                </div>
                                                <div className="flex border-b border-gray-300 pb-2">
                                                    <span className="font-bold w-32 text-lg">الصفحة:</span>
                                                    <span className="text-xl font-mono">{singlePrintStudent.page}</span>
                                                </div>
                                                <div className="flex border-b border-gray-300 pb-2">
                                                    <span className="font-bold w-32 text-lg">تاريخ الإضافة:</span>
                                                    <span className="text-xl">{new Date(singlePrintStudent.timestamp).toLocaleDateString('ar-EG')}</span>
                                                </div>
                                                {singlePrintStudent.note && (
                                                    <div className="flex border-b border-gray-300 pb-2">
                                                        <span className="font-bold w-32 text-lg">ملاحظات:</span>
                                                        <span className="text-lg">{singlePrintStudent.note}</span>
                                                    </div>
                                                )}
                                            </div>

                                            <div className="mt-12 w-full flex justify-between px-8">
                                                <div className="text-center">
                                                    <p className="font-bold mb-8">شؤون الطلاب</p>
                                                    <p>..................</p>
                                                </div>
                                                <div className="text-center">
                                                    <p className="font-bold mb-8">مدير المدرسة</p>
                                                    <p>..................</p>
                                                </div>
                                            </div>
                                            
                                            <div className="no-print w-full mt-8 flex justify-center">
                                                <button 
                                                    onClick={() => setSinglePrintStudent(null)} 
                                                    className="bg-slate-200 px-4 py-2 rounded hover:bg-slate-300"
                                                >
                                                    بحث عن طالب آخر
                                                </button>
                                            </div>
                                        </div>
                                    ) : (printMode === 'full' || (printMode === 'qaid' && targetQaid)) ? (
                                        // List Print View (Used for both Full and Batch Qaid)
                                        (() => {
                                            const ROWS_PER_COL = 35;
                                            const ROWS_PER_PAGE = ROWS_PER_COL * 2;
                                            
                                            // Determine which dataset to print
                                            let dataToPrint = [];
                                            let title = "";
                                            
                                            if (printMode === 'qaid' && targetQaid) {
                                                dataToPrint = students.filter(s => s.qaid === targetQaid);
                                                title = `قائمة طلاب القيد رقم: ${targetQaid}`;
                                            } else {
                                                // Force Alphabetical Sort for Full Record Print
                                                dataToPrint = [...filteredStudents].sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                                                title = "فهرس القيد الشامل";
                                            }

                                            const pages = [];
                                            
                                            // Chunking data into pages
                                            for(let i = 0; i < dataToPrint.length; i += ROWS_PER_PAGE) {
                                                pages.push(dataToPrint.slice(i, i + ROWS_PER_PAGE));
                                            }

                                            if (pages.length === 0) return <div className="p-10 text-center">لا توجد بيانات للطباعة</div>;

                                            return pages.map((pageData, pageIdx) => (
                                                <div key={pageIdx} className="print-page flex flex-col p-4 box-border">
                                                    {/* Header per page */}
                                                    <div className="text-center mb-4 border-b-2 border-black pb-2">
                                                        <h1 className="text-xl font-extrabold">{title}</h1>
                                                        <p className="text-xs">تاريخ: {new Date().toLocaleDateString('ar-EG')} - صفحة {pageIdx + 1}</p>
                                                    </div>

                                                    <div className="flex justify-between gap-4 flex-grow items-start h-full">
                                                        {/* Right Column (First half of page data) */}
                                                        <div className="w-[49%]">
                                                            <PrintTable 
                                                                data={pageData.slice(0, ROWS_PER_COL)} 
                                                                startIndex={pageIdx * ROWS_PER_PAGE} 
                                                                rowsPerCol={ROWS_PER_COL}
                                                            />
                                                        </div>
                                                        
                                                        {/* Left Column (Second half of page data) */}
                                                        <div className="w-[49%]">
                                                            <PrintTable 
                                                                data={pageData.slice(ROWS_PER_COL, ROWS_PER_PAGE)} 
                                                                startIndex={pageIdx * ROWS_PER_PAGE + ROWS_PER_COL} 
                                                                rowsPerCol={ROWS_PER_COL}
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            ));
                                        })()
                                    ) : null}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Toast Notification */}
                    {toast && (
                        <div className={`fixed bottom-6 left-6 z-[100] px-6 py-4 rounded-xl shadow-2xl text-white font-medium flex items-center gap-3 animate-in fade-in slide-in-from-bottom-4 duration-300 ${toast.type === 'success' ? 'bg-emerald-600' : 'bg-red-600'}`}>
                            {toast.type === 'success' ? <Check size={20} /> : <AlertTriangle size={20} />}
                            {toast.msg}
                        </div>
                    )}
                </div>
            );
        }

        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(
            <React.StrictMode>
                <App />
            </React.StrictMode>
        );
    /* ]]> */
    </script>
</body>
</html>--- START OF FILE types.ts ---
--- START OF FILE firebase.ts ---
--- START OF FILE App.tsx ---
