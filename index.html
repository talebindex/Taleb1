<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نظام الأرشيف الذكي - النسخة المتطورة</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

// تكوين Firebase
const firebaseConfig = {
    apiKey: "AIzaSyC-RyeNVI6aNmWSJIYhQCG_4J_RQDAovds",
    authDomain: "student-archive-f8689.firebaseapp.com",
    projectId: "student-archive-f8689",
    storageBucket: "student-archive-f8689.appspot.com",
    messagingSenderId: "815104091476",
    appId: "1:815104091476:web:8e725238d8ebabaf26d4c1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const studentsCol = collection(db, "students");

let deleteTargetId = null;
window.allStudentsData = [];
window.activeLetter = null;
let unsavedChanges = false;

// إشعارات
window.showToast = (msg, type = 'success') => {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-trash-alt'}"></i> ${msg}`;
    container.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 3000);
};

// تسجيل الدخول
onAuthStateChanged(auth, (user) => {
    document.getElementById('loginPage').style.display = user ? 'none' : 'flex';
    document.getElementById('appContent').style.display = user ? 'block' : 'none';
    if(user) { loadData(); }
});

function loadData() {
    onSnapshot(query(studentsCol, orderBy("timestamp", "desc")), (snapshot) => {
        window.allStudentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateQuickStats();
        updateQaidFilter();
        updateDuplicateFilter(); // لتفعيل فلتر المكررين
        window.applyFilters(); 
    });
}

function updateQuickStats() {
    const startOfDay = new Date().setHours(0,0,0,0);
    document.getElementById('statTotal').innerText = window.allStudentsData.length;
    document.getElementById('statToday').innerText = window.allStudentsData.filter(s => s.timestamp >= startOfDay).length;
    document.getElementById('statQaids').innerText = new Set(window.allStudentsData.map(s => s.qaid)).size;
}

function updateQaidFilter() {
    const qaidSelect = document.getElementById('filterQaid');
    const uniqueQaids = [...new Set(window.allStudentsData.map(s => s.qaid))].sort();
    qaidSelect.innerHTML = '<option value="">جميع القيود</option>';
    uniqueQaids.forEach(q => {
        qaidSelect.innerHTML += `<option value="${q}">قيد ${q}</option>`;
    });
}

// فلتر المكررين
function updateDuplicateFilter() {
    const duplicateSelect = document.getElementById('filterDuplicate');
    if(!duplicateSelect) return;
    duplicateSelect.innerHTML = '<option value="">عرض الكل</option><option value="duplicates">المكررين فقط</option>';
}

// تطبيق الفلاتر
window.applyFilters = () => {
    const term = document.getElementById('searchInput').value.toLowerCase();
    const sortBy = document.getElementById('sortSelect').value;
    const filterQaid = document.getElementById('filterQaid').value;
    const filterPage = document.getElementById('filterPage').value;
    const filterDuplicate = document.getElementById('filterDuplicate') ? document.getElementById('filterDuplicate').value : '';
    
    let filtered = window.allStudentsData.filter(s => {
        const matchSearch = (s.name || '').toLowerCase().includes(term) || String(s.qaid).includes(term);
        const matchQaid = filterQaid ? String(s.qaid) === filterQaid : true;
        const matchPage = filterPage ? String(s.page).includes(filterPage) : true;
        let matchDuplicate = true;
        if(filterDuplicate === "duplicates") {
            const counts = window.allStudentsData.reduce((acc, st) => {
                acc[st.name] = (acc[st.name] || 0) + 1;
                return acc;
            }, {});
            matchDuplicate = counts[s.name] > 1;
        }
        return matchSearch && matchQaid && matchPage && matchDuplicate;
    });
    
    if (sortBy === "alpha") filtered.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
    else if (sortBy === "qaid") filtered.sort((a, b) => String(a.qaid).localeCompare(String(b.qaid)));
    else if (sortBy === "page") filtered.sort((a, b) => String(a.page).localeCompare(String(b.page)));
    
    window.render(filtered);
};

// دالة حذف الطالب
window.del = (id) => { deleteTargetId = id; document.getElementById('deleteModal').style.display = 'flex'; };
window.confirmDel = async () => { 
    if(deleteTargetId) { 
        await deleteDoc(doc(db, "students", deleteTargetId)); 
        showToast("تم الحذف", "error"); 
        document.getElementById('deleteModal').style.display = 'none'; 
    } 
};

// عرض قائمة الطلاب مع تمييز المكررين
window.render = (data) => {
    const list = document.getElementById('studentsList');
    list.innerHTML = ''; 
    const counts = data.reduce((acc, s) => { acc[s.name] = (acc[s.name] || 0) + 1; return acc; }, {});
    data.forEach((s, idx) => {
        const isDuplicate = counts[s.name] > 1;
        list.innerHTML += `
        <div class="student-item card" style="${isDuplicate ? 'background:#fef3c7;border-left:4px solid #f59e0b;' : ''}">
            <div class="card-body-wrapper">
                <div class="user-icon" title="آخر رقمين من القيد: ${String(s.qaid).slice(-2)}">
                    <i class="fas fa-user-graduate"></i>
                    <small class="qaid-end">${String(s.qaid).slice(-2)}</small>
                </div>
                <div class="student-details">
                    <p class="student-name">${s.name} <small class="surname-text">${s.surname || ''}</small> ${isDuplicate ? '<i class="fas fa-exclamation-circle" style="color:#f59e0b;margin-left:5px;" title="مكرر"></i>' : ''}</p>
                    <div class="student-meta">
                        <span class="highlight-badge qaid-badge" title="رقم القيد">
                            <i class="fas fa-hashtag"></i> ${s.qaid}
                        </span>
                        <span class="highlight-badge page-badge" title="رقم الصفحة">
                            <i class="fas fa-file-alt"></i> ${s.page}
                        </span>
                    </div>
                </div>
            </div>
            <div class="item-actions">
                <button onclick="copyStudentData('${s.id}')" class="copy-btn-small" title="نسخ البيانات">
                    <i class="fas fa-copy"></i>
                </button>
                <button onclick="edit('${s.id}')" class="edit-btn-small" title="تعديل">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="del('${s.id}')" class="del-btn-small" title="حذف">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>`;
    });
};
</script>

<style>
/* --- بعض أنماط العرض الأساسية --- */
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana,sans-serif; margin:0; padding:5px; background:#f8fafc; color:#334155; }
.student-name { font-size:1.1rem; font-weight:700; }
.print-area table th, .print-area table td { font-size:14px; }
/* الألوان المكررة */
.student-item.card { transition: all 0.2s; }
</style>
</head>
<body>
<div id="toastContainer"></div>
<div id="loginPage" style="display:flex;height:100vh;align-items:center;justify-content:center;">تسجيل الدخول</div>
<div id="appContent" style="display:none;">
    <div class="advanced-filters">
        <select id="filterQaid" onchange="applyFilters()"><option value="">جميع القيود</option></select>
        <input type="text" id="filterPage" placeholder="بحث بالصفحة" oninput="applyFilters()">
        <select id="filterDuplicate" onchange="applyFilters()"></select>
        <input type="text" id="searchInput" placeholder="بحث بالاسم أو القيد" oninput="applyFilters()">
        <select id="sortSelect" onchange="applyFilters()">
            <option value="newest">الأحدث أولاً</option>
            <option value="alpha">الاسم أبجدياً</option>
            <option value="qaid">رقم القيد</option>
            <option value="page">رقم الصفحة</option>
        </select>
    </div>
    <div id="studentsList"></div>
</div>
</body>
</html>
