<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الطلاب - نسخة الصور والضغط الذكي</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC-RyeNVI6aNmWSJIYhQCG_4J_RQDAovds",
            authDomain: "student-archive-f8689.firebaseapp.com",
            projectId: "student-archive-f8689",
            storageBucket: "student-archive-f8689.appspot.com",
            messagingSenderId: "815104091476",
            appId: "1:815104091476:web:8e725238d8ebabaf26d4c1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        const studentsCol = collection(db, "students");

        // دالة ضغط الصور الذكية
        async function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1200; // تقليل العرض للحفاظ على الجودة والمساحة
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/jpeg', 0.7); // جودة 70% مثالية جداً للتخزين
                    };
                };
            });
        }

        window.login = async () => {
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value);
            } catch (e) { alert("فشل الدخول!"); }
        };

        onAuthStateChanged(auth, (user) => {
            document.getElementById('loginPage').style.display = user ? 'none' : 'block';
            document.getElementById('appContent').style.display = user ? 'block' : 'none';
            if(user) loadData();
        });

        window.saveData = async () => {
            const fileInput = document.getElementById('studentImg');
            let imageUrl = document.getElementById('currentImgUrl').value || "";
            const btn = document.getElementById('saveBtn');

            btn.innerText = "جاري معالجة ورفع الصورة...";
            btn.disabled = true;

            try {
                if (fileInput.files[0]) {
                    const compressedBlob = await compressImage(fileInput.files[0]);
                    const storageRef = ref(storage, 'students/' + Date.now() + ".jpg");
                    const snapshot = await uploadBytes(storageRef, compressedBlob);
                    imageUrl = await getDownloadURL(snapshot.ref);
                }

                const data = {
                    name: document.getElementById('fName').value,
                    qaid: document.getElementById('qNum').value,
                    photo: imageUrl,
                    timestamp: Date.now()
                };

                const id = document.getElementById('editId').value;
                if(id) await updateDoc(doc(db, "students", id), data);
                else await addDoc(studentsCol, data);

                alert("تم الحفظ بنجاح!");
                resetForm();
                location.reload();
            } catch (e) {
                alert("خطأ: " + e.message);
                btn.disabled = false;
            }
        };

        function loadData() {
            onSnapshot(query(studentsCol, orderBy("timestamp", "desc")), (snap) => {
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';
                snap.forEach(doc => {
                    const s = doc.data();
                    tbody.innerHTML += `<tr>
                        <td><img src="${s.photo || 'https://via.placeholder.com/50'}" class="student-thumb"></td>
                        <td>${s.name}</td>
                        <td>${s.qaid}</td>
                        <td><button class="btn-del" onclick="deleteStudent('${doc.id}')">حذف</button></td>
                    </tr>`;
                });
            });
        }

        window.deleteStudent = async (id) => {
            if(confirm('هل تريد حذف الطالب؟')) await deleteDoc(doc(db, 'students', id));
        };

        function resetForm() {
            document.getElementById('editId').value = '';
            document.getElementById('fName').value = '';
            document.getElementById('qNum').value = '';
            document.getElementById('studentImg').value = '';
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: rtl; background: #eef2f3; padding: 15px; }
        .card { background: white; padding: 25px; border-radius: 15px; max-width: 500px; margin: auto; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; outline: none; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #0056b3; }
        .student-thumb { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #007bff; }
        table { width: 100%; background: white; margin-top: 20px; border-radius: 10px; overflow: hidden; border-collapse: collapse; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #333; }
        .btn-del { background: #ff4757; padding: 5px 10px; font-size: 12px; }
    </style>
</head>
<body>

<div id="loginPage" class="card" style="margin-top: 50px;">
    <h2 style="text-align: center;">دخول النظام</h2>
    <input type="email" id="email" placeholder="البريد الإلكتروني">
    <input type="password" id="pass" placeholder="كلمة السر">
    <button onclick="login()">دخول</button>
</div>

<div id="appContent" style="display:none;" class="card">
    <h3 style="text-align: center;">إضافة طالب وصورة (ضغط ذكي)</h3>
    <input type="hidden" id="editId">
    <input type="hidden" id="currentImgUrl">
    <input type="text" id="fName" placeholder="الاسم الكامل للطلب">
    <input type="text" id="qNum" placeholder="رقم القيد">
    <label style="font-size: 13px; color: #666;">صورة الطالب (حتى لو كانت 15MP سيتم ضغطها):</label>
    <input type="file" id="studentImg" accept="image/*">
    <button id="saveBtn" onclick="saveData()">حفظ البيانات والصورة</button>

    <table>
        <thead>
            <tr><th>الصورة</th><th>الاسم</th><th>القيد</th><th>إجراء</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

</body>
</html>
