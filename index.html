<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ - Firebase</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    
    <script type="module">
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø§Øª Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc } 
        from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
        const firebaseConfig = {
            apiKey: "AIzaSyC-RyeNVI6aNmWSJIYhQCG_4J_RQDAovds",
            authDomain: "student-archive-f8689.firebaseapp.com",
            databaseURL: "https://student-archive-f8689-default-rtdb.firebaseio.com",
            projectId: "student-archive-f8689",
            storageBucket: "student-archive-f8689.firebasestorage.app",
            messagingSenderId: "815104091476",
            appId: "1:815104091476:web:8e725238d8ebabaf26d4c1",
            measurementId: "G-X9CCBWXFF0"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const studentsCol = collection(db, "students");

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ
        window.saveData = async () => {
            const id = document.getElementById('editId').value;
            const student = {
                name: document.getElementById('fName').value.trim(),
                mother: document.getElementById('mName').value.trim(),
                qaid: document.getElementById('qNum').value.trim(),
                page: document.getElementById('pNum').value.trim(),
                note: document.getElementById('note').value.trim(),
                timestamp: Date.now()
            };

            if(!student.name || !student.qaid) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯");

            try {
                if(id) {
                    await updateDoc(doc(db, "students", id), student);
                } else {
                    await addDoc(studentsCol, student);
                }
                resetForm();
            } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: " + e.message); }
        };

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ø¸ÙŠØ§Ù‹
        const q = query(studentsCol, orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            const list = [];
            snapshot.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
            window.allStudents = list;
            render(list);
        });

        // Ø­Ø°Ù Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
        window.del = async (id) => {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ')) {
                await deleteDoc(doc(db, "students", id));
            }
        };

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        window.edit = (id) => {
            const s = window.allStudents.find(x => x.id === id);
            document.getElementById('editId').value = s.id;
            document.getElementById('fName').value = s.name;
            document.getElementById('mName').value = s.mother;
            document.getElementById('qNum').value = s.qaid;
            document.getElementById('pNum').value = s.page;
            document.getElementById('note').value = s.note;
            document.getElementById('saveBtn').innerText = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©';
            document.getElementById('cancelBtn').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
    </script>

    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --info: #3498db; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); padding: 20px; margin: 0; text-align: right; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { text-align: center; color: var(--primary); margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .entry-form { background: #f8f9fa; padding: 20px; border-radius: 10px; border: 2px solid #e9ecef; margin-bottom: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; color: #555; }
        .form-group input, .form-group textarea { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: inherit; }
        .full-width { grid-column: 1 / -1; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 0.95rem; }
        .btn-save { background: var(--success); color: white; }
        .btn-excel { background: var(--info); color: white; }
        .btn-import { background: #8e44ad; color: white; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #fff; padding: 10px; border-radius: 8px; }
        #searchInput { padding: 10px 15px; width: 300px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid #eee; padding: 15px; text-align: right; }
        th { background: #2c3e50; color: white; }
        tr:nth-child(even) { background: #fdfdfd; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; background: #eee; }
    </style>
</head>
<body>

<div class="container">
    <h2>Ø³Ø¬Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</h2>

    <div class="entry-form">
        <input type="hidden" id="editId">
        <div class="form-group">
            <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ</label>
            <input type="text" id="fName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„">
        </div>
        <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ø£Ù…</label>
            <input type="text" id="mName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ù…">
        </div>
        <div class="form-group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯</label>
            <input type="text" id="qNum" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯">
        </div>
        <div class="form-group">
            <label>Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©</label>
            <input type="number" id="pNum" placeholder="Ø§Ù„ØµÙØ­Ø©">
        </div>
        <div class="form-group full-width">
            <label>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <textarea id="note" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>
        </div>
        <div class="full-width">
            <button class="btn btn-save" id="saveBtn" onclick="saveData()" style="width: 100%;">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</button>
            <button class="btn" id="cancelBtn" onclick="resetForm()" style="width: 100%; margin-top: 5px; display: none; background: #95a5a6; color: white;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
        </div>
    </div>

    <div class="controls">
        <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø«..." onkeyup="search()">
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-import" onclick="document.getElementById('fileInput').click()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥ÙƒØ³Ù„</button>
            <input type="file" id="fileInput" hidden accept=".xlsx, .xls" onchange="importExcel(event)">
            <button class="btn btn-excel" onclick="exportExcel()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ø£Ù…</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯</th>
                <th>Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©</th>
                <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    function render(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        data.forEach(s => {
            tbody.innerHTML += `<tr>
                <td>${s.name}</td>
                <td>${s.mother}</td>
                <td><span class="badge">${s.qaid}</span></td>
                <td>${s.page}</td>
                <td style="font-size: 0.85rem; color: #666;">${s.note || '-'}</td>
                <td>
                    <button onclick="edit('${s.id}')" style="color:var(--info); background:none; border:none; cursor:pointer; font-weight:bold;">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button onclick="del('${s.id}')" style="color:red; background:none; border:none; cursor:pointer; font-weight:bold; margin-right:10px;">Ø­Ø°Ù</button>
                </td>
            </tr>`;
        });
    }

    function resetForm() {
        document.getElementById('editId').value = '';
        document.querySelectorAll('.entry-form input, .entry-form textarea').forEach(e => e.value = '');
        document.getElementById('saveBtn').innerText = 'Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©';
        document.getElementById('cancelBtn').style.display = 'none';
    }

    function search() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const filtered = window.allStudents.filter(s => s.name.toLowerCase().includes(q) || s.qaid.includes(q));
        render(filtered);
    }

    function exportExcel() {
        if (!window.allStudents.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª");
        const ws = XLSX.utils.json_to_sheet(window.allStudents.map(s => ({
            "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ": s.name, "Ø§Ø³Ù… Ø§Ù„Ø£Ù…": s.mother, "Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯": s.qaid, "Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©": s.page, "Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª": s.note
        })));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Students");
        XLSX.writeFile(wb, "Database_Export.xlsx");
    }

    async function importExcel(e) {
        alert("ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù„Ù„Ø³Ø­Ø§Ø¨Ø© ØªØªØ·Ù„Ø¨ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¯ÙØ¹Ø§Øª (Batch). ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø­Ø§Ù„ÙŠØ§Ù‹.");
    }
</script>
</body>
</html>
