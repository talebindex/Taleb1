<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الأرشيف الذكي - النسخة المتطورة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, writeBatch, getDocs } 
        from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } 
        from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC-RyeNVI6aNmWSJIYhQCG_4J_RQDAovds",
            authDomain: "student-archive-f8689.firebaseapp.com",
            projectId: "student-archive-f8689",
            storageBucket: "student-archive-f8689.appspot.com",
            messagingSenderId: "815104091476",
            appId: "1:815104091476:web:8e725238d8ebabaf26d4c1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const studentsCol = collection(db, "students");

        let deleteTargetId = null;
        window.allStudentsData = [];
        window.activeLetter = null;
        let unsavedChanges = false;

        // متغيرات العرض التدريجي
        let displayLimit = 50; 
        let filteredDataGlobal = [];

        window.showToast = (msg, type = 'success') => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-trash-alt'}"></i> ${msg}`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        };

        onAuthStateChanged(auth, (user) => {
            document.getElementById('loginPage').style.display = user ? 'none' : 'flex';
            document.getElementById('appContent').style.display = user ? 'block' : 'none';
            if(user) {
                loadData();
            }
        });

        function loadData() {
            onSnapshot(query(studentsCol, orderBy("timestamp", "desc")), (snapshot) => {
                window.allStudentsData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                updateQuickStats();
                updateQaidFilter();
                window.applyFilters(); 
            });
        }

        function updateQuickStats() {
            const startOfDay = new Date().setHours(0,0,0,0);
            document.getElementById('statTotal').innerText = window.allStudentsData.length;
            document.getElementById('statToday').innerText = window.allStudentsData.filter(s => s.timestamp >= startOfDay).length;
            document.getElementById('statQaids').innerText = new Set(window.allStudentsData.map(s => s.qaid)).size;
        }

        function updateQaidFilter() {
            const qaidSelect = document.getElementById('filterQaid');
            const uniqueQaids = [...new Set(window.allStudentsData.map(s => s.qaid))].sort();
            qaidSelect.innerHTML = '<option value="">جميع القيود</option>';
            uniqueQaids.forEach(q => {
                qaidSelect.innerHTML += `<option value="${q}">قيد ${q}</option>`;
            });
        }

        window.applyFilters = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const sortBy = document.getElementById('sortSelect').value;
            const filterQaid = document.getElementById('filterQaid').value;
            const filterPage = document.getElementById('filterPage').value;
            
            let filtered = window.allStudentsData.filter(s => {
                const matchSearch = 
                    (s.name || '').toLowerCase().includes(term) || 
                    (s.surname || '').toLowerCase().includes(term) ||
                    String(s.qaid).includes(term);
                
                const matchQaid = filterQaid ? String(s.qaid) === filterQaid : true;
                const matchPage = filterPage ? String(s.page).includes(filterPage) : true;
                
                return matchSearch && matchQaid && matchPage;
            });

            if (sortBy === "alpha") {
                filtered.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            } else if (sortBy === "qaid") {
                filtered.sort((a, b) => String(a.qaid).localeCompare(String(b.qaid)));
            } else if (sortBy === "page") {
                filtered.sort((a, b) => String(a.page).localeCompare(String(b.page)));
            } else if (sortBy === "surname") {
                filtered.sort((a, b) => (a.surname || '').localeCompare(b.surname || '', 'ar'));
            }

            displayLimit = 50; 
            filteredDataGlobal = filtered;
            window.render(filtered.slice(0, displayLimit));
        };

        window.loadMore = () => {
            displayLimit += 50;
            window.render(filteredDataGlobal.slice(0, displayLimit));
        };

        window.clearFilters = () => {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterQaid').value = '';
            document.getElementById('filterPage').value = '';
            document.getElementById('sortSelect').value = 'newest';
            window.applyFilters();
            showToast("تم مسح جميع الفلاتر");
        };

        window.downloadExcelTemplate = () => {
            const templateData = [
                ["الاسم", "اللقب", "القيد", "الصفحة", "ملاحظات"],
                ["أحمد محمد علي", "الكبيسي", "12345", "25", "-"],
                ["سارة خالد حسن", "العبيدي", "12346", "26", "طالبة متفوقة"]
            ];
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "الطلاب");
            XLSX.writeFile(wb, "نموذج_اسماء_الطلاب.xlsx");
            showToast("تم تحميل النموذج بنجاح");
        };

        function isDuplicateQaidPage(qaid, page, existingStudents, excludeId = null) {
            return existingStudents.some(student => 
                (excludeId ? student.id !== excludeId : true) &&
                String(student.qaid).trim() === String(qaid).trim() &&
                String(student.page).trim() === String(page).trim()
            );
        }

        window.importExcel = (event) => {
            const file = event.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            document.getElementById('loader').style.display = 'flex';

            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(firstSheet);
                    
                    const existingStudents = window.allStudentsData;
                    let added = 0;
                    let skipped = 0;
                    const chunkSize = 100;

                    for (let i = 0; i < json.length; i += chunkSize) {
                        const batch = writeBatch(db);
                        const chunk = json.slice(i, i + chunkSize);
                        
                        chunk.forEach((row) => {
                            const rName = String(row.name || row["الاسم"] || "").trim();
                            const rQaid = String(row.qaid || row["القيد"] || "").trim();
                            const rPage = String(row.page || row["الصفحة"] || "").trim();
                            
                            if (rName === "" || rQaid === "" || rPage === "" || isDuplicateQaidPage(rQaid, rPage, existingStudents)) {
                                skipped++;
                                return;
                            }
                            
                            const newDocRef = doc(collection(db, "students"));
                            batch.set(newDocRef, {
                                name: rName, 
                                surname: String(row.surname || row["اللقب"] || "").trim(),
                                qaid: rQaid,
                                page: rPage,
                                note: String(row.note || row["ملاحظات"] || "").trim(),
                                timestamp: Date.now()
                            });
                            added++;
                        });
                        
                        await batch.commit();
                        console.log(`تم رفع الدفعة رقم ${Math.ceil((i+1)/chunkSize)}`);
                    }
                    
                    if (added > 0) {
                        showToast(`تم استيراد ${added} طالب بنجاح (تم تخطي ${skipped})`);
                    } else {
                        showToast("لم يتم استيراد أي بيانات جديدة", "error");
                    }
                    
                } catch(err) {
                    console.error(err);
                    showToast("حدث خطأ أثناء معالجة الملف", "error");
                }
                document.getElementById('loader').style.display = 'none';
                event.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        };

        window.exportExcel = () => {
            const dataToExport = window.allStudentsData.map(({id, timestamp, ...rest}) => rest);
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "الطلاب");
            XLSX.writeFile(wb, "ارشيف_الطلاب.xlsx");
        };

        window.openMasterDelete = () => {
            document.getElementById('masterDeleteInput').value = '';
            document.getElementById('masterDeleteModal').style.display = 'flex';
        };

        window.confirmMasterDelete = async () => {
            const confirmText = document.getElementById('masterDeleteInput').value;
            if(confirmText !== 'حذف') {
                showToast("يرجى كتابة كلمة حذف للتأكيد", "error");
                return;
            }
            
            document.getElementById('loader').style.display = 'flex';
            try {
                const snapshot = await getDocs(studentsCol);
                const batchSize = 500;
                let batches = [];
                let currentBatch = writeBatch(db);
                let count = 0;

                snapshot.docs.forEach((docSnap) => {
                    currentBatch.delete(docSnap.ref);
                    count++;
                    if (count === batchSize) {
                        batches.push(currentBatch.commit());
                        currentBatch = writeBatch(db);
                        count = 0;
                    }
                });
                
                if (count > 0) batches.push(currentBatch.commit());
                await Promise.all(batches);
                
                showToast("تم مسح السجل بالكامل بنجاح", "error");
                document.getElementById('masterDeleteModal').style.display = 'none';
            } catch(e) {
                showToast("حدث خطأ أثناء مسح البيانات", "error");
            }
            document.getElementById('loader').style.display = 'none';
        };

        window.showPrintOptions = () => {
            const qaidSelect = document.getElementById('qaidSelect');
            qaidSelect.innerHTML = '<option value="">-- اختر رقم القيد --</option>';
            const uniqueQaids = [...new Set(window.allStudentsData.map(s => s.qaid))].sort();
            uniqueQaids.forEach(q => {
                qaidSelect.innerHTML += `<option value="${q}">قيد رقم ${q}</option>`;
            });
            document.getElementById('printModal').style.display = 'flex';
        };

        window.printSelectedQaid = () => {
            const selectedQaid = document.getElementById('qaidSelect').value;
            if(!selectedQaid) return;
            const dataToPrint = window.allStudentsData
                .filter(s => String(s.qaid) === String(selectedQaid))
                .sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            executePrint(dataToPrint, `سجل الطلاب - القيد رقم (${selectedQaid})`);
        };

        window.printAllAlpha = () => {
            const dataToPrint = [...window.allStudentsData].sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            executePrint(dataToPrint, "سجل الطلاب العام - ترتيب أبجدي");
        };

        function executePrint(data, title) {
            document.getElementById('printTitle').innerText = title;
            const container = document.getElementById('printTablesContainer');
            container.innerHTML = '';

            const rowsPerColumn = 35;
            const totalRowsPerPage = 70;

            for (let pageNum = 0; pageNum < Math.ceil(data.length / totalRowsPerPage); pageNum++) {
                const pageStartIndex = pageNum * totalRowsPerPage;
                const pageData = data.slice(pageStartIndex, pageStartIndex + totalRowsPerPage);
                
                const pageDiv = document.createElement('div');
                pageDiv.className = 'print-page';
                
                const rightColumnData = pageData.slice(0, rowsPerColumn);
                const leftColumnData = pageData.slice(rowsPerColumn, totalRowsPerPage);

                // --- تعديل: إزالة عمود اللقب وتكبير حجم الخط إلى 14 ---
                const createTableHTML = (columnData, startSequence) => {
                    let tableHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:35px">ت</th>
                                    <th>الاسم الرباعي</th>
                                    <th style="width:70px">القيد</th>
                                    <th style="width:55px">ص</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    for (let i = 0; i < rowsPerColumn; i++) {
                        const student = columnData[i];
                        const sequence = startSequence + i;
                        if (student) {
                            tableHTML += `
                                <tr>
                                    <td style="font-size:14pt">${sequence}</td>
                                    <td style="text-align:right; padding-right:8px; font-size:14pt; font-weight:bold;">${student.name || ''}</td>
                                    <td style="font-size:14pt">${student.qaid || ''}</td>
                                    <td style="font-size:14pt">${student.page || ''}</td>
                                </tr>`;
                        } else {
                            tableHTML += `<tr><td>${sequence}</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>`;
                        }
                    }
                    tableHTML += `</tbody></table>`;
                    return tableHTML;
                };

                pageDiv.innerHTML = `
                    <div class="print-grid">
                        <div class="print-col print-col-right">
                            ${createTableHTML(rightColumnData, pageStartIndex + 1)}
                        </div>
                        <div class="print-col print-col-left">
                            ${createTableHTML(leftColumnData, pageStartIndex + rowsPerColumn + 1)}
                        </div>
                    </div>
                `;
                container.appendChild(pageDiv);
            }

            document.getElementById('printDate').innerText = "تاريخ الاستخراج: " + new Date().toLocaleDateString('ar-EG');
            document.getElementById('printModal').style.display = 'none';
            setTimeout(() => { window.print(); }, 500);
        }

        window.saveData = async () => {
            const id = document.getElementById('editId').value;
            const name = document.getElementById('fName').value.trim();
            const qaid = document.getElementById('qNum').value.trim();
            const page = document.getElementById('pNum').value.trim();
            const surname = document.getElementById('surname').value.trim();
            const note = document.getElementById('note').value.trim();

            if(!name || !qaid || !page) {
                showToast("يرجى إكمال البيانات الأساسية", "error");
                return;
            }

            if (isDuplicateQaidPage(qaid, page, window.allStudentsData, id)) {
                showToast("هذا القيد والصفحة مسجلين مسبقاً لطالب آخر", "error");
                return;
            }

            try {
                const studentData = {
                    name,
                    surname,
                    qaid,
                    page,
                    note,
                    timestamp: Date.now()
                };

                if(id) {
                    await updateDoc(doc(db, "students", id), studentData);
                    showToast("تم تحديث البيانات بنجاح");
                } else {
                    await addDoc(studentsCol, studentData);
                    showToast("تم إضافة الطالب بنجاح");
                }
                
                window.closeAddModal();
                window.resetForm();
                unsavedChanges = false;
            } catch(e) {
                showToast("خطأ في الاتصال بالشبكة", "error");
            }
        };

        window.del = (id) => {
            deleteTargetId = id;
            document.getElementById('deleteModal').style.display = 'flex';
        };

        window.confirmDel = async () => {
            if(deleteTargetId) {
                try {
                    await deleteDoc(doc(db, "students", deleteTargetId));
                    showToast("تم حذف بيانات الطالب بنجاح", "error");
                    document.getElementById('deleteModal').style.display = 'none';
                    deleteTargetId = null;
                } catch(e) {
                    showToast("خطأ في عملية الحذف", "error");
                }
            }
        };

        window.copyStudentData = (id) => {
            const student = window.allStudentsData.find(s => s.id === id);
            if(student) {
                const text = `الاسم: ${student.name}\nاللقب: ${student.surname || 'لا يوجد'}\nالقيد: ${student.qaid}\nالصفحة: ${student.page}`;
                navigator.clipboard.writeText(text).then(() => {
                    showToast("تم نسخ بيانات الطالب للمحرر");
                });
            }
        };

        window.duplicateLastStudent = () => {
            if (window.allStudentsData.length > 0) {
                const lastStudent = window.allStudentsData[0];
                document.getElementById('fName').value = lastStudent.name;
                document.getElementById('surname').value = lastStudent.surname;
                document.getElementById('qNum').value = lastStudent.qaid;
                document.getElementById('pNum').value = lastStudent.page;
                document.getElementById('note').value = lastStudent.note;
                showToast("تم نسخ بيانات آخر طالب مضاف");
                unsavedChanges = true;
            } else {
                showToast("لا توجد بيانات سابقة للنسخ", "error");
            }
        };

        window.generateRandomData = () => {
            const names = ["أحمد محمد علي كمال", "سارة خالد حسن العبيدي", "علي محمود سعيد الجبوري", "مريم يوسف إبراهيم", "فاطمة عباس جاسم"];
            const surnames = ["الكبيسي", "العبيدي", "الجبوري", "الساعدي", "اللامي"];
            
            document.getElementById('fName').value = names[Math.floor(Math.random() * names.length)];
            document.getElementById('surname').value = surnames[Math.floor(Math.random() * surnames.length)];
            document.getElementById('qNum').value = Math.floor(Math.random() * 90000) + 10000;
            document.getElementById('pNum').value = Math.floor(Math.random() * 50) + 1;
            document.getElementById('note').value = "بيانات تجريبية مولدة تلقائياً";
            showToast("تم توليد بيانات تجريبية");
            unsavedChanges = true;
        };

        window.render = (data) => {
            const list = document.getElementById('studentsList');
            
            if (displayLimit === 50) {
                list.innerHTML = '';
            } else {
                const oldBtn = document.getElementById('loadMoreBtn');
                if (oldBtn) oldBtn.remove();
            }
            
            let html = '';
            data.forEach((s, index) => {
                html += `
                    <div class="student-item card" style="animation: slideIn ${0.2 + (index % 10) * 0.05}s ease-out;">
                        <div class="student-number">${index + 1}</div>
                        <div class="card-body-wrapper">
                            <div class="user-icon" title="آخر رقمين من القيد: ${String(s.qaid).slice(-2)}">
                                <i class="fas fa-user-graduate"></i>
                                <small class="qaid-end">${String(s.qaid).slice(-2)}</small>
                            </div>
                            <div class="student-details">
                                <p class="student-name">
                                    ${s.name} 
                                    ${s.surname ? `<span class="surname-badge">${s.surname}</span>` : ''}
                                </p>
                                <div class="student-meta">
                                    <span class="highlight-badge qaid-badge" title="رقم القيد">
                                        <i class="fas fa-hashtag"></i> ${s.qaid}
                                    </span>
                                    <span class="highlight-badge page-badge" title="رقم الصفحة">
                                        <i class="fas fa-file-alt"></i> ${s.page}
                                    </span>
                                    ${s.note ? `<span class="note-indicator" title="${s.note}"><i class="fas fa-comment-dots"></i></span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button onclick="copyStudentData('${s.id}')" class="action-btn copy-btn-small" title="نسخ البيانات">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="edit('${s.id}')" class="action-btn edit-btn-small" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="del('${s.id}')" class="action-btn del-btn-small" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>`;
            });

            list.insertAdjacentHTML('beforeend', html);

            if (filteredDataGlobal.length > displayLimit) {
                const remaining = filteredDataGlobal.length - displayLimit;
                const loadMoreBtn = `
                    <button id="loadMoreBtn" onclick="loadMore()" class="btn" style="background:var(--blue); width:200px; margin: 20px auto; display:block; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);">
                        عرض المزيد (${remaining})
                    </button>`;
                list.insertAdjacentHTML('beforeend', loadMoreBtn);
            }
        };

        window.edit = (id) => {
            const s = window.allStudentsData.find(x => x.id === id);
            if(s) {
                document.getElementById('editId').value = s.id;
                document.getElementById('fName').value = s.name;
                document.getElementById('surname').value = s.surname || '';
                document.getElementById('qNum').value = s.qaid;
                document.getElementById('pNum').value = s.page;
                document.getElementById('note').value = s.note || '';
                document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> تحديث البيانات';
                document.getElementById('entryModal').style.display = 'flex';
                unsavedChanges = false;
                setupInputListeners();
            }
        };

        function setupInputListeners() {
            const inputs = document.querySelectorAll('#entryModal input, #entryModal textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    unsavedChanges = true;
                });
            });
        }

        window.openAddModal = () => {
            window.resetForm();
            document.getElementById('entryModal').style.display = 'flex';
            unsavedChanges = false;
            setupInputListeners();
        };

        window.closeAddModal = () => {
            if (unsavedChanges) {
                if (confirm("هناك تغييرات لم يتم حفظها، هل تريد الخروج؟")) {
                    document.getElementById('entryModal').style.display = 'none';
                }
            } else {
                document.getElementById('entryModal').style.display = 'none';
            }
        };

        window.resetForm = () => {
            document.getElementById('editId').value = '';
            document.querySelectorAll('#entryModal input, #entryModal textarea').forEach(i => i.value = '');
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-plus"></i> حفظ الطالب';
            const existingAlert = document.getElementById('duplicateStudentAlert');
            if(existingAlert) existingAlert.remove();
        };

        window.login = async () => {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            const btn = document.querySelector('#loginPage .btn');
            
            if(!email || !pass) return showToast("أدخل بيانات الدخول", "error");
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الدخول...';
            
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch(e) {
                showToast("فشل الدخول: تأكد من البريد وكلمة المرور", "error");
                btn.disabled = false;
                btn.innerHTML = 'دخول';
            }
        };

        window.logout = () => {
            if(confirm("هل تريد تسجيل الخروج؟")) signOut(auth);
        };

        window.toggleDarkMode = () => {
            document.body.classList.toggle('dark-mode');
            const icon = document.querySelector('.theme-toggle i');
            if(document.body.classList.contains('dark-mode')) {
                icon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            } else {
                icon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            }
        };

        window.checkDuplicateStudent = () => {
            const nameInput = document.getElementById('fName');
            const nameValue = nameInput.value.trim();
            const existingAlert = document.getElementById('duplicateStudentAlert');
            if(existingAlert) existingAlert.remove();

            if(nameValue.length > 3) {
                const duplicate = window.allStudentsData.find(s => 
                    s.name.trim().toLowerCase() === nameValue.toLowerCase()
                );
                if(duplicate) {
                    const alertDiv = document.createElement('div');
                    alertDiv.id = 'duplicateStudentAlert';
                    alertDiv.className = 'duplicate-alert';
                    alertDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> تنبيه: طالب بنفس الاسم مسجل (قيد: ${duplicate.qaid} | صفحة: ${duplicate.page})`;
                    nameInput.parentNode.insertBefore(alertDiv, nameInput.nextSibling);
                }
            }
        };

        window.toggleSettings = (e) => {
            e.stopPropagation();
            const dropdown = document.getElementById('settingsDropdown');
            dropdown.classList.toggle('show');
            
            const closeDropdown = () => {
                dropdown.classList.remove('show');
                document.removeEventListener('click', closeDropdown);
            };
            document.addEventListener('click', closeDropdown);
        };

        if(localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }
    </script>
    
    <style>
        :root {
            --main: #1e293b;
            --blue: #0ea5e9;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #334155;
            --accent: #6366f1;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --surname: #7c3aed;
            --border: #e2e8f0;
        }

        body.dark-mode {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
            --surname: #a78bfa;
            --border: #334155;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            direction: rtl;
            margin: 0;
            transition: background 0.3s, color 0.3s;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: auto;
            padding: 15px;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: var(--card);
            padding: 15px 20px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .header-title {
            margin: 0;
            font-size: 1.4rem;
            color: var(--blue);
            font-weight: 800;
        }

        .card {
            background: var(--card);
            padding: 15px;
            border-radius: 16px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: var(--card);
            padding: 15px;
            border-radius: 16px;
            text-align: center;
            border-bottom: 4px solid var(--blue);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .stat-val {
            display: block;
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--blue);
        }

        .stat-label {
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0.8;
        }

        .main-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn {
            border: none;
            border-radius: 12px;
            cursor: pointer;
            padding: 12px 20px;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
        }

        .btn:active { transform: scale(0.95); }

        .advanced-filters {
            background: var(--card);
            padding: 15px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .advanced-filters select, .advanced-filters input {
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            flex: 1;
            min-width: 140px;
            font-weight: 600;
        }

        .search-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--card);
            padding: 5px 20px;
            border-radius: 50px;
            border: 2px solid var(--blue);
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.1);
        }

        .search-wrapper i { color: var(--blue); font-size: 1.2rem; }
        .search-wrapper input {
            border: none;
            width: 100%;
            padding: 12px 0;
            outline: none;
            background: transparent;
            color: inherit;
            font-size: 1rem;
            font-weight: 600;
        }

        .student-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-right: 5px solid var(--blue);
            padding: 12px 20px;
            position: relative;
        }

        .student-number {
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--blue);
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            z-index: 2;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .card-body-wrapper { display: flex; align-items: center; gap: 15px; flex: 1; }

        .user-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--blue);
            flex-shrink: 0;
        }
        
        body.dark-mode .user-icon { background: linear-gradient(135deg, #0c4a6e, #075985); color: #7dd3fc; }

        .qaid-end { font-size: 0.65rem; font-weight: 800; margin-top: -2px; }

        .student-name { margin: 0 0 8px 0; font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; flex-wrap: wrap; gap: 8px; }

        .surname-badge {
            background: var(--surname);
            color: white;
            padding: 2px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .student-meta { display: flex; gap: 10px; align-items: center; }

        .highlight-badge {
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .qaid-badge { background: #e0f2fe; color: #0369a1; }
        .page-badge { background: #fef9c3; color: #854d0e; }
        body.dark-mode .qaid-badge { background: #082f49; color: #7dd3fc; }
        body.dark-mode .page-badge { background: #422006; color: #fde047; }

        .item-actions { display: flex; gap: 8px; }

        .action-btn {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .copy-btn-small { background: #f1f5f9; color: #64748b; }
        .edit-btn-small { background: #ecfdf5; color: #059669; }
        .del-btn-small { background: #fef2f2; color: #dc2626; }
        
        body.dark-mode .copy-btn-small { background: #334155; color: #cbd5e1; }
        body.dark-mode .edit-btn-small { background: #064e3b; color: #6ee7b7; }
        body.dark-mode .del-btn-small { background: #450a0a; color: #fca5a5; }

        .action-btn:hover { transform: translateY(-2px); filter: brightness(0.9); }

        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            backdrop-filter: blur(6px);
            padding: 15px;
        }

        .modal-content {
            background: var(--card);
            padding: 30px;
            border-radius: 24px;
            width: 100%;
            max-width: 450px;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .modal-content h3 { margin: 0 0 20px 0; color: var(--blue); text-align: center; font-size: 1.5rem; }

        .modal-content input, .modal-content textarea, .modal-content select {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 1rem;
            box-sizing: border-box;
            font-family: inherit;
        }

        .modal-content textarea { height: 100px; resize: none; }

        .duplicate-alert {
            background: #fffbeb;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 10px;
            border-radius: 10px;
            font-size: 0.85rem;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 30px;
            padding: 15px 25px;
            border-radius: 12px;
            color: white;
            z-index: 9999;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            transition: all 0.5s ease;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        .loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 15px;
        }
        body.dark-mode .loader { background: rgba(15, 23, 42, 0.8); }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border);
            border-top: 5px solid var(--blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .theme-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--main);
            color: white;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 4000;
            font-size: 1.4rem;
            transition: all 0.3s;
        }

        .settings-container { position: relative; }

        .settings-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            width: 42px;
            height: 42px;
            border-radius: 12px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-dropdown {
            position: absolute;
            left: 0;
            top: 55px;
            background: var(--card);
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            min-width: 200px;
            display: none;
            padding: 10px;
            z-index: 1000;
            border: 1px solid var(--border);
        }

        .settings-dropdown.show { display: block; animation: dropdownFade 0.2s ease-out; }

        @keyframes dropdownFade { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .settings-dropdown button {
            width: 100%;
            padding: 12px;
            border: none;
            background: none;
            text-align: right;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            border-radius: 10px;
            transition: background 0.2s;
        }

        .settings-dropdown button:hover { background: var(--bg); color: var(--blue); }

        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        /* تسيق الطباعة المحدث */
        @media print {
            .no-print { display: none !important; }
            .print-area { display: block !important; padding: 0; margin: 0; }
            .print-page { page-break-after: always; padding: 10mm; height: 277mm; position: relative; }
            .print-grid { display: flex; gap: 10mm; justify-content: space-between; height: 100%; }
            .print-col { width: 48%; }
            table { width: 100%; border-collapse: collapse; table-layout: fixed; border: 1.5px solid #000; }
            th, td { border: 1px solid #000; padding: 4px 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; }
            th { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; font-size: 12pt; }
            /* تكبير الخط للاسماء والارقام حسب الطلب */
            td { font-size: 14pt !important; } 
            .print-title-area { text-align: center; border-bottom: 2px solid #000; margin-bottom: 5px; padding-bottom: 5px; }
        }

        .print-area { display: none; background: white; color: black; }
        
        #loginPage input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 1rem;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

<div id="loader" class="loader">
    <div class="spinner"></div>
    <strong style="font-size: 1.1rem;">جاري معالجة البيانات...</strong>
    <span style="font-size: 0.9rem; opacity: 0.8;">يرجى عدم إغلاق الصفحة</span>
</div>

<div id="toastContainer"></div>

<div id="masterDeleteModal" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--danger)"><i class="fas fa-exclamation-triangle"></i> حذف الأرشيف بالكامل</h3>
        <p style="text-align:center; font-weight:600;">سيتم حذف كافة بيانات الطلاب نهائياً. لا يمكن التراجع عن هذه الخطوة.</p>
        <p style="text-align:center; font-size:0.9rem; color:var(--danger)">لتأكيد الحذف، اكتب كلمة "حذف" في الحقل أدناه:</p>
        <input type="text" id="masterDeleteInput" placeholder="اكتب حذف هنا..." style="text-align:center; border-color:var(--danger)">
        <div style="display:flex; gap:12px; margin-top:20px;">
            <button class="btn" style="background:var(--danger); flex:2;" onclick="confirmMasterDelete()">تأكيد المسح النهائي</button>
            <button class="btn" style="background:#64748b; flex:1;" onclick="document.getElementById('masterDeleteModal').style.display='none'">إلغاء</button>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal">
    <div class="modal-content" style="max-width:350px; text-align:center;">
        <div style="color:var(--danger); font-size:3rem; margin-bottom:15px;"><i class="fas fa-trash-alt"></i></div>
        <h4>هل أنت متأكد من حذف هذا الطالب؟</h4>
        <div style="display:flex; gap:12px; margin-top:25px;">
            <button class="btn" style="background:var(--danger); flex:1;" onclick="confirmDel()">نعم، احذف</button>
            <button class="btn" style="background:#64748b; flex:1;" onclick="document.getElementById('deleteModal').style.display='none'">تراجع</button>
        </div>
    </div>
</div>

<div id="entryModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">بيانات الطالب</h3>
        <input type="hidden" id="editId">
        
        <label style="font-size:0.85rem; font-weight:700; display:block; margin-bottom:5px;">الاسم الكامل:</label>
        <input type="text" id="fName" placeholder="الاسم الرباعي للطالب" oninput="checkDuplicateStudent()">
        
        <label style="font-size:0.85rem; font-weight:700; display:block; margin-bottom:5px;">اللقب / العشيرة:</label>
        <input type="text" id="surname" placeholder="مثال: الكبيسي، الجبوري...">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div>
                <label style="font-size:0.85rem; font-weight:700; display:block; margin-bottom:5px;">رقم القيد:</label>
                <input type="text" id="qNum" placeholder="القيد">
            </div>
            <div>
                <label style="font-size:0.85rem; font-weight:700; display:block; margin-bottom:5px;">رقم الصفحة:</label>
                <input type="number" id="pNum" placeholder="الصفحة">
            </div>
        </div>
        
        <label style="font-size:0.85rem; font-weight:700; display:block; margin-bottom:5px;">ملاحظات إضافية:</label>
        <textarea id="note" placeholder="اكتب أي ملاحظات تتعلق بالطالب هنا..."></textarea>
        
        <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
            <button id="saveBtn" class="btn" style="background:var(--main);" onclick="saveData()">
                <i class="fas fa-plus"></i> حفظ الطالب
            </button>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:var(--accent); flex:1; font-size:0.8rem;" onclick="duplicateLastStudent()">
                    <i class="fas fa-copy"></i> تكرار الأخير
                </button>
                <button class="btn" style="background:#64748b; flex:1; font-size:0.8rem;" onclick="closeAddModal()">إلغاء</button>
            </div>
        </div>
    </div>
</div>

<div id="printModal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-print"></i> خيارات الطباعة</h3>
        <p style="text-align:center; font-size:0.9rem; margin-bottom:20px;">اختر نوع السجل الذي ترغب في طباعته</p>
        
        <button class="btn" style="background:var(--accent); width:100%; margin-bottom:15px" onclick="printAllAlpha()">
            <i class="fas fa-sort-alpha-down"></i> طباعة السجل العام (أبجدي)
        </button>
        
        <div style="border-top:1px solid var(--border); padding-top:15px;">
            <label style="font-size:0.85rem; font-weight:700; display:block; margin-bottom:8px;">طباعة قيد محدد:</label>
            <select id="qaidSelect" style="margin-bottom:10px;"></select>
            <button class="btn" style="background:var(--blue); width:100%;" onclick="printSelectedQaid()">
                <i class="fas fa-file-invoice"></i> معاينة وطباعة القيد
            </button>
        </div>
        
        <button class="btn" style="background:#64748b; width:100%; margin-top:20px" onclick="document.getElementById('printModal').style.display='none'">إغلاق</button>
    </div>
</div>

<div id="loginPage" style="height: 100vh; flex-direction: column; align-items: center; justify-content: center; display: none; background: linear-gradient(135deg, var(--main), var(--blue));">
    <div class="card" style="width: 90%; max-width: 400px; text-align: center; padding: 40px 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border:none;">
        <div style="font-size: 4rem; color: var(--blue); margin-bottom: 20px;"><i class="fas fa-shield-alt"></i></div>
        <h2 style="margin-bottom: 10px;">نظام الأرشيف الذكي</h2>
        <p style="opacity: 0.7; margin-bottom: 30px;">يرجى تسجيل الدخول للمتابعة</p>
        
        <div style="text-align:right;">
            <label style="font-weight:700; font-size:0.9rem;">البريد الإلكتروني:</label>
            <input type="email" id="loginEmail" placeholder="example@email.com">
            
            <label style="font-weight:700; font-size:0.9rem;">كلمة المرور:</label>
            <input type="password" id="loginPass" placeholder="••••••••">
        </div>
        
        <button class="btn" style="background:var(--main); width:100%; height:50px; font-size:1.1rem; margin-top:10px;" onclick="login()">دخول للنظام</button>
    </div>
</div>

<div id="appContent" class="container" style="display: none;">
    <div class="print-area">
        <div class="print-title-area">
            <h2 id="printTitle" style="margin:0;"></h2>
            <div style="display:flex; justify-content:space-between; margin-top:5px; font-weight:bold; font-size:12px;">
                <span id="printDate"></span>
                <span>نظام الأرشيف الإلكتروني</span>
            </div>
        </div>
        <div id="printTablesContainer"></div>
    </div>

    <div class="no-print">
        <div class="header-container">
            <h4 class="header-title"><i class="fas fa-archive"></i> الأرشيف الإلكتروني</h4>
            <div style="display:flex; gap:12px; align-items:center;">
                <div class="settings-container">
                    <button class="settings-btn" onclick="toggleSettings(event)" title="الإعدادات والأدوات">
                        <i class="fas fa-cog"></i>
                    </button>
                    <div class="settings-dropdown" id="settingsDropdown">
                        <button onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-file-import" style="color:var(--success)"></i> استيراد من Excel
                        </button>
                        <button onclick="downloadExcelTemplate()">
                            <i class="fas fa-download" style="color:var(--blue)"></i> تحميل النموذج القياسي
                        </button>
                        <button onclick="exportExcel()">
                            <i class="fas fa-file-export" style="color:var(--warning)"></i> تصدير قاعدة البيانات
                        </button>
                        <button onclick="showPrintOptions()">
                            <i class="fas fa-print" style="color:var(--accent)"></i> خيارات الطباعة
                        </button>
                        <button onclick="generateRandomData()">
                            <i class="fas fa-vial" style="color:#64748b"></i> توليد بيانات تجريبية
                        </button>
                        <div style="border-top:1px solid var(--border); margin:5px 0;"></div>
                        <button onclick="openMasterDelete()" style="color:var(--danger)">
                            <i class="fas fa-trash-alt"></i> مسح السجل بالكامل
                        </button>
                    </div>
                </div>
                <button onclick="logout()" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:1.2rem;" title="تسجيل الخروج">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-val" id="statTotal">0</span>
                <span class="stat-label">إجمالي الطلاب</span>
            </div>
            <div class="stat-item" style="border-bottom-color:var(--success)">
                <span class="stat-val" style="color:var(--success)" id="statToday">0</span>
                <span class="stat-label">مضاف اليوم</span>
            </div>
            <div class="stat-item" style="border-bottom-color:var(--accent)">
                <span class="stat-val" style="color:var(--accent)" id="statQaids">0</span>
                <span class="stat-label">عدد القيود</span>
            </div>
        </div>

        <div class="main-actions">
            <button class="btn" style="background:var(--main); box-shadow: 0 4px 12px rgba(30, 41, 59, 0.2);" onclick="openAddModal()">
                <i class="fas fa-plus-circle"></i> إضافة طالب جديد
            </button>
            <button class="btn" onclick="clearFilters()" style="background:#64748b;" title="إعادة تعيين كافة الفلاتر">
                <i class="fas fa-filter-circle-xmark"></i> مسح الفلاتر
            </button>
        </div>
        
        <input type="file" id="fileInput" hidden onchange="importExcel(event)" accept=".xlsx, .xls">

        <div class="advanced-filters">
            <div style="flex:1; min-width:150px;">
                <label style="font-size:0.75rem; font-weight:700; margin-bottom:5px; display:block;">تصفية حسب القيد:</label>
                <select id="filterQaid" onchange="applyFilters()">
                    <option value="">جميع القيود</option>
                </select>
            </div>
            <div style="flex:1; min-width:150px;">
                <label style="font-size:0.75rem; font-weight:700; margin-bottom:5px; display:block;">رقم الصفحة:</label>
                <input type="number" id="filterPage" placeholder="رقم الصفحة..." oninput="applyFilters()">
            </div>
            <div style="flex:1; min-width:150px;">
                <label style="font-size:0.75rem; font-weight:700; margin-bottom:5px; display:block;">ترتيب النتائج:</label>
                <select id="sortSelect" onchange="applyFilters()">
                    <option value="newest">الأحدث أولاً</option>
                    <option value="alpha">الاسم (أبجدي)</option>
                    <option value="surname">اللقب (أبجدي)</option>
                    <option value="qaid">حسب القيد</option>
                    <option value="page">حسب الصفحة</option>
                </select>
            </div>
        </div>

        <div class="search-wrapper">
            <input type="text" id="searchInput" placeholder="ابحث عن اسم، لقب، أو رقم قيد..." onkeyup="applyFilters()">
        </div>

        <div id="studentsList"></div>
    </div>
</div>

<div class="theme-toggle no-print" onclick="toggleDarkMode()" title="تبديل الوضع الليلي/النهاري">
    <i class="fas fa-moon"></i>
</div>

</body>
</html>
